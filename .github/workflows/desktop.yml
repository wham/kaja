name: desktop
on:
  pull_request:

jobs:
  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install npm dependencies
        working-directory: ui
        run: npm ci

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install protoc and Node.js binary
        run: |
          source scripts/common
          install_protoc $PWD/server/build
          install_nodejs $PWD/server/build

      - name: Build UI
        working-directory: server
        run: go run cmd/build-ui/main.go

      - name: Prepare desktop frontend
        run: |
          rm -rf desktop/frontend/dist
          mkdir -p desktop/frontend/dist
          cp server/build/main.css desktop/frontend/dist/
          cp server/build/main.js desktop/frontend/dist/
          cp server/build/monaco.*.worker.js desktop/frontend/dist/
          cp -r server/static desktop/frontend/dist/
          mv desktop/frontend/dist/static/index.html desktop/frontend/dist/index.html

      - name: Build desktop app
        working-directory: desktop
        run: wails build -ldflags "-X main.GitRef=${{ github.sha }}"

      - name: Create DMG
        run: |
          brew install create-dmg
          # create-dmg returns exit code 1 when it can't sign (expected in CI)
          create-dmg \
            --volname "Kaja" \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Kaja.app" 150 200 \
            --app-drop-link 450 200 \
            desktop/build/bin/Kaja.dmg \
            desktop/build/bin/Kaja.app \
            || true
          test -f desktop/build/bin/Kaja.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Kaja.dmg
          path: desktop/build/bin/Kaja.dmg

      - name: Build server
        working-directory: server
        run: go build -ldflags "-X main.GitRef=${{ github.sha }}" -o build/server ./cmd/server

      - name: Start server
        run: |
          cd server && ./build/server &
          echo "Waiting for server to start..."
          for i in $(seq 1 60); do
            if curl -s http://localhost:41520/status > /dev/null 2>&1; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Convert video to GIF
        run: |
          brew install ffmpeg
          ffmpeg -i .github/demo/demo.webm -vf "fps=10,scale=960:-1:flags=lanczos" -c:v gif .github/demo/demo.gif
          rm .github/demo/demo.webm

      - name: Upload demo (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-demo
          path: .github/demo/

      - name: Remove demo from PR on failure
        if: failure() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"

          # Setup git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Remove demo assets from demo-assets branch if it exists
          git fetch origin demo-assets 2>/dev/null || true
          if git rev-parse --verify origin/demo-assets >/dev/null 2>&1; then
            git checkout demo-assets
            if [ -d "pr-${PR_NUMBER}/desktop" ]; then
              git rm -rf "pr-${PR_NUMBER}/desktop"
              git commit -m "Remove Desktop demo assets for PR #${PR_NUMBER} (demo failed)" || echo "No changes"
              git push origin demo-assets
            fi
          fi

          # Remove Desktop Demo section from PR description
          gh pr view ${PR_NUMBER} --json body --jq '.body' > /tmp/current_body.txt
          perl -0777 -pe 's/\n*<details>\s*<summary>ðŸŽ¬ Desktop Demo<\/summary>.*?<\/details>//sg' /tmp/current_body.txt > /tmp/body_clean.txt

          # Only update if there was a demo section to remove
          if ! diff -q /tmp/current_body.txt /tmp/body_clean.txt > /dev/null 2>&1; then
            gh pr edit ${PR_NUMBER} --body-file /tmp/body_clean.txt
            echo "Removed Desktop Demo section from PR description"
          fi

      - name: Upload demo assets and update PR description
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"

          # Save demo files before switching branches
          cp -r .github/demo /tmp/demo-files

          # Setup git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or update demo-assets branch
          git fetch origin demo-assets 2>/dev/null || true

          if git rev-parse --verify origin/demo-assets >/dev/null 2>&1; then
            git checkout demo-assets
            git pull origin demo-assets --rebase || true
          else
            git checkout --orphan demo-assets
            git rm -rf . 2>/dev/null || true
            git commit --allow-empty -m "Initialize demo-assets branch"
          fi

          # Copy demo files to PR-specific folder
          mkdir -p "pr-${PR_NUMBER}/desktop"
          cp /tmp/demo-files/*.gif /tmp/demo-files/*.png "pr-${PR_NUMBER}/desktop/" 2>/dev/null || true

          # Commit and push
          git add "pr-${PR_NUMBER}/"
          git commit -m "Desktop demo assets for PR #${PR_NUMBER}" || echo "No changes"
          git push origin demo-assets

          # Build URLs
          BASE_URL="https://raw.githubusercontent.com/${REPO}/demo-assets/pr-${PR_NUMBER}/desktop"
          GIF_URL="${BASE_URL}/demo.gif"
          HOME_URL="${BASE_URL}/home.png"
          CALL_URL="${BASE_URL}/call.png"
          COMPILER_URL="${BASE_URL}/compiler.png"

          # Build demo section
          echo "<details>" > /tmp/demo.md
          echo "<summary>ðŸŽ¬ Desktop Demo</summary>" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Video" >> /tmp/demo.md
          echo "![Demo](${GIF_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Home" >> /tmp/demo.md
          echo "![Home](${HOME_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Call" >> /tmp/demo.md
          echo "![Call](${CALL_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Compiler" >> /tmp/demo.md
          echo "![Compiler](${COMPILER_URL})" >> /tmp/demo.md

          if [ -f /tmp/demo-files/newproject.png ]; then
            echo "" >> /tmp/demo.md
            echo "### New Project" >> /tmp/demo.md
            echo "![New Project](${BASE_URL}/newproject.png)" >> /tmp/demo.md
          fi

          echo "" >> /tmp/demo.md
          echo "</details>" >> /tmp/demo.md

          # Get current PR body and remove existing Desktop Demo section
          gh pr view ${PR_NUMBER} --json body --jq '.body' > /tmp/current_body.txt
          perl -0777 -pe 's/\n*<details>\s*<summary>ðŸŽ¬ Desktop Demo<\/summary>.*?<\/details>//sg' /tmp/current_body.txt > /tmp/body_clean.txt

          # Combine body with demo section
          cat /tmp/body_clean.txt > /tmp/new_body.txt
          echo "" >> /tmp/new_body.txt
          cat /tmp/demo.md >> /tmp/new_body.txt

          # Update PR description
          gh pr edit ${PR_NUMBER} --body-file /tmp/new_body.txt
