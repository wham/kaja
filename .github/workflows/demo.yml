name: demo
on:
  workflow_dispatch:
  pull_request:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build . -t kaja-dev:latest --build-arg RUN_TESTS=true

      - name: Start Docker container
        run: |
          docker run --name kaja-dev -d -p 41520:41520 \
            -v $PWD/workspace:/workspace \
            kaja-dev:latest

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if docker logs kaja-dev 2>&1 | grep -q "Server started"; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Setup CML
        if: github.event_name == 'pull_request'
        uses: iterative/setup-cml@v2

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Upload error screenshot (artifact)
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: Error
          path: .github/demo/error.png

      - name: Attach error to PR comment
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          printf '%s\n' \
            "## ðŸŽ¬ Demo" \
            "" \
            "### Error" \
            "![Error](.github/demo/error.png)" \
            > .github/demo/report.md
          cml comment create --update .github/demo/report.md

      - name: Upload demo (artifact)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: demo
          path: .github/demo/

      - name: Post demo to PR comment
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          printf '%s\n' \
            "## ðŸŽ¬ Demo" \
            "" \
            "### Video" \
            "" \
            "![Demo](.github/demo/demo.webm)" \
            "" \
            "### Home" \
            "![Home](.github/demo/home.png)" \
            "" \
            "### Call" \
            "![Call](.github/demo/call.png)" \
            "" \
            "### Compiler" \
            "![Compiler](.github/demo/compiler.png)" \
            > .github/demo/report.md

          if [ -f .github/demo/newproject.png ]; then
            printf '%s\n' \
              "" \
              "### New Project" \
              "![New Project](.github/demo/newproject.png)" \
              >> .github/demo/report.md
          fi

          cml comment create --update .github/demo/report.md
