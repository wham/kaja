name: demo
on:
  workflow_dispatch:
  pull_request:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build . -t kaja-dev:latest --build-arg RUN_TESTS=true --build-arg GIT_REF=${{ github.sha }}

      - name: Start Docker container
        run: |
          docker run --name kaja-dev -d -p 41520:41520 \
            -v $PWD/workspace:/workspace \
            kaja-dev:latest

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if docker logs kaja-dev 2>&1 | grep -q "Server started"; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Convert video to GIF
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffmpeg -i .github/demo/demo.webm -vf "fps=10,scale=960:-1:flags=lanczos" -c:v gif .github/demo/demo.gif
          rm .github/demo/demo.webm

      - name: Upload demo (artifact)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: demo
          path: .github/demo/

      - name: Remove demo from PR on failure
        if: failure() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          TAG="demo-assets"

          # Delete this PR's assets from the release
          gh release view "$TAG" --json assets --jq '.assets[].name' 2>/dev/null | \
            grep "^pr-${PR_NUMBER}-" | \
            while read -r name; do
              gh release delete-asset "$TAG" "$name" --yes 2>/dev/null || true
            done

          # Remove Demo section from PR description
          gh pr view ${PR_NUMBER} --json body --jq '.body' > /tmp/current_body.txt
          perl -0777 -pe 's/\n*<details>\s*<summary>ðŸŽ¬ Demo<\/summary>.*?<\/details>//sg' /tmp/current_body.txt > /tmp/body_clean.txt

          # Only update if there was a demo section to remove
          if ! diff -q /tmp/current_body.txt /tmp/body_clean.txt > /dev/null 2>&1; then
            gh pr edit ${PR_NUMBER} --body-file /tmp/body_clean.txt
            echo "Removed demo section from PR description"
          fi

      - name: Upload demo assets and update PR description
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"
          TAG="demo-assets"

          # Create the release if it doesn't exist yet
          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "Demo Assets" --notes "Auto-generated demo screenshots for PRs."

          # Delete stale assets for this PR before uploading fresh ones
          gh release view "$TAG" --json assets --jq '.assets[].name' 2>/dev/null | \
            grep "^pr-${PR_NUMBER}-" | \
            while read -r name; do
              gh release delete-asset "$TAG" "$name" --yes 2>/dev/null || true
            done

          # Rename files with PR prefix and upload
          UPLOAD_FILES=()
          for f in .github/demo/*.gif .github/demo/*.png; do
            [ -f "$f" ] || continue
            name="pr-${PR_NUMBER}-$(basename "$f")"
            cp "$f" ".github/demo/$name"
            UPLOAD_FILES+=(".github/demo/$name")
          done
          gh release upload "$TAG" "${UPLOAD_FILES[@]}" --clobber

          # Build URLs (release asset download URL pattern)
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          GIF_URL="${BASE_URL}/pr-${PR_NUMBER}-demo.gif"
          HOME_URL="${BASE_URL}/pr-${PR_NUMBER}-home.png"
          CALL_URL="${BASE_URL}/pr-${PR_NUMBER}-call.png"
          COMPILER_URL="${BASE_URL}/pr-${PR_NUMBER}-compiler.png"

          # Build demo section
          echo "<details>" > /tmp/demo.md
          echo "<summary>ðŸŽ¬ Demo</summary>" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Video" >> /tmp/demo.md
          echo "![Demo](${GIF_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Home" >> /tmp/demo.md
          echo "![Home](${HOME_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Call" >> /tmp/demo.md
          echo "![Call](${CALL_URL})" >> /tmp/demo.md
          echo "" >> /tmp/demo.md
          echo "### Compiler" >> /tmp/demo.md
          echo "![Compiler](${COMPILER_URL})" >> /tmp/demo.md

          if [ -f ".github/demo/pr-${PR_NUMBER}-newproject.png" ]; then
            echo "" >> /tmp/demo.md
            echo "### New Project" >> /tmp/demo.md
            echo "![New Project](${BASE_URL}/pr-${PR_NUMBER}-newproject.png)" >> /tmp/demo.md
          fi

          echo "" >> /tmp/demo.md
          echo "</details>" >> /tmp/demo.md

          # Get current PR body and remove existing Demo section
          gh pr view ${PR_NUMBER} --json body --jq '.body' > /tmp/current_body.txt
          perl -0777 -pe 's/\n*<details>\s*<summary>ðŸŽ¬ Demo<\/summary>.*?<\/details>//sg' /tmp/current_body.txt > /tmp/body_clean.txt

          # Combine body with demo section
          cat /tmp/body_clean.txt > /tmp/new_body.txt
          echo "" >> /tmp/new_body.txt
          cat /tmp/demo.md >> /tmp/new_body.txt

          # Update PR description
          gh pr edit ${PR_NUMBER} --body-file /tmp/new_body.txt
