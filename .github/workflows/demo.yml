name: demo
on:
  workflow_dispatch:
  pull_request:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build . -t kaja-dev:latest --build-arg RUN_TESTS=true

      - name: Start Docker container
        run: |
          docker run --name kaja-dev -d -p 41520:41520 \
            -v $PWD/workspace:/workspace \
            kaja-dev:latest

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if docker logs kaja-dev 2>&1 | grep -q "Server started"; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Convert video to GIF
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffmpeg -i .github/demo/demo.webm -vf "fps=10,scale=960:-1:flags=lanczos" -c:v gif .github/demo/demo.gif

      - name: Upload error screenshot (artifact)
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: Error
          path: .github/demo/error.png

      - name: Attach error to PR comment
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"

          # Push error screenshot to demo-assets branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin demo-assets || git checkout --orphan demo-assets
          git checkout demo-assets || git checkout --orphan demo-assets

          mkdir -p "pr-${PR_NUMBER}"
          cp .github/demo/error.png "pr-${PR_NUMBER}/"
          git add "pr-${PR_NUMBER}/"
          git commit -m "Demo assets for PR #${PR_NUMBER}" --allow-empty
          git push origin demo-assets --force

          # Create comment with raw GitHub URL
          ERROR_URL="https://raw.githubusercontent.com/${REPO}/demo-assets/pr-${PR_NUMBER}/error.png"

          gh pr comment ${PR_NUMBER} --body "## ðŸŽ¬ Demo

### Error
![Error](${ERROR_URL})"

      - name: Upload demo (artifact)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: demo
          path: .github/demo/

      - name: Post demo to PR comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"

          # Push demo assets to demo-assets branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stash demo files before switching branches
          cp -r .github/demo /tmp/demo-files

          # Create or checkout demo-assets branch
          git fetch origin demo-assets 2>/dev/null && git checkout demo-assets || {
            git checkout --orphan demo-assets
            git rm -rf . 2>/dev/null || true
          }

          # Copy demo files and commit
          mkdir -p "pr-${PR_NUMBER}"
          cp /tmp/demo-files/*.gif /tmp/demo-files/*.png "pr-${PR_NUMBER}/" 2>/dev/null || true
          git add "pr-${PR_NUMBER}/"
          git commit -m "Demo assets for PR #${PR_NUMBER}" --allow-empty
          git push origin demo-assets --force

          # Build URLs
          BASE_URL="https://raw.githubusercontent.com/${REPO}/demo-assets/pr-${PR_NUMBER}"
          GIF_URL="${BASE_URL}/demo.gif"
          HOME_URL="${BASE_URL}/home.png"
          CALL_URL="${BASE_URL}/call.png"
          COMPILER_URL="${BASE_URL}/compiler.png"

          # Build comment body
          BODY="## ðŸŽ¬ Demo

![Demo](${GIF_URL})

<details>
<summary>Screenshots</summary>

### Home
![Home](${HOME_URL})

### Call
![Call](${CALL_URL})

### Compiler
![Compiler](${COMPILER_URL})"

          # Add new project screenshot if exists
          if [ -f /tmp/demo-files/newproject.png ]; then
            NEWPROJECT_URL="${BASE_URL}/newproject.png"
            BODY="${BODY}

### New Project
![New Project](${NEWPROJECT_URL})"
          fi

          BODY="${BODY}

</details>"

          # Find and update existing demo comment, or create new one
          EXISTING_COMMENT=$(gh pr view ${PR_NUMBER} --json comments --jq '.comments[] | select(.body | startswith("## ðŸŽ¬ Demo")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            gh api repos/${REPO}/issues/comments/${EXISTING_COMMENT} -X PATCH -f body="$BODY"
          else
            gh pr comment ${PR_NUMBER} --body "$BODY"
          fi
