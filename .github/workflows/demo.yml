name: demo
on:
  workflow_dispatch:
  pull_request:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build . -t kaja-dev:latest --build-arg RUN_TESTS=true

      - name: Start Docker container
        run: |
          docker run --name kaja-dev -d -p 41520:41520 \
            -v $PWD/workspace:/workspace \
            kaja-dev:latest

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if docker logs kaja-dev 2>&1 | grep -q "Server started"; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Setup CML
        if: github.event_name == 'pull_request'
        uses: iterative/setup-cml@v2

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Upload error screenshot (artifact)
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: Error
          path: .github/demo/error.png

      - name: Attach error screenshot to PR
        if: failure() && steps.demo.outcome == 'failure' && github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Upload error image to GitHub CDN via CML
          ERROR_URL=$(cml publish .github/demo/error.png)

          # Get current PR body
          CURRENT_BODY=$(gh pr view ${PR_NUMBER} --json body -q .body)

          # Remove existing Demo section if present
          BODY_WITHOUT_DEMO=$(echo "$CURRENT_BODY" | perl -0777 -pe 's/\n*<details>\s*<summary>.*?Demo.*?<\/summary>.*?<\/details>\s*//sg')

          # Create demo section with error (collapsed by default)
          DEMO_SECTION=$(printf '<details>\n<summary>ðŸŽ¬ Demo</summary>\n\n### Error\n![Error](%s)\n\n</details>' "$ERROR_URL")

          # Combine body with demo section at the end
          printf -v NEW_BODY '%s\n\n%s' "$BODY_WITHOUT_DEMO" "$DEMO_SECTION"

          # Update PR description
          gh pr edit ${PR_NUMBER} --body "$NEW_BODY"

      - name: Upload demo (artifact)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: demo
          path: .github/demo/

      - name: Update PR description
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Upload video to GitHub CDN via CML
          VIDEO_URL=$(cml publish .github/demo/demo.webm)

          # Upload images to GitHub CDN via CML
          HOME_URL=$(cml publish .github/demo/home.png)
          CALL_URL=$(cml publish .github/demo/call.png)
          COMPILER_URL=$(cml publish .github/demo/compiler.png)

          # New Project screenshot is optional
          NEWPROJECT_SECTION=""
          if [ -f .github/demo/newproject.png ]; then
            NEWPROJECT_URL=$(cml publish .github/demo/newproject.png)
            NEWPROJECT_SECTION=$(printf '\n\n### New Project\n![New Project](%s)' "$NEWPROJECT_URL")
          fi

          # Get current PR body
          CURRENT_BODY=$(gh pr view ${PR_NUMBER} --json body -q .body)

          # Remove existing Demo section if present
          BODY_WITHOUT_DEMO=$(echo "$CURRENT_BODY" | perl -0777 -pe 's/\n*<details>\s*<summary>.*?Demo.*?<\/summary>.*?<\/details>\s*//sg')

          # Create new demo section (closed by default) - video first, then screenshots
          DEMO_SECTION=$(printf '<details>\n<summary>ðŸŽ¬ Demo</summary>\n\n### Video\n\n%s\n\n### Home\n![Home](%s)\n\n### Call\n![Call](%s)\n\n### Compiler\n![Compiler](%s)%s\n\n</details>' "$VIDEO_URL" "$HOME_URL" "$CALL_URL" "$COMPILER_URL" "$NEWPROJECT_SECTION")

          # Combine body with demo section at the end
          printf -v NEW_BODY '%s\n\n%s' "$BODY_WITHOUT_DEMO" "$DEMO_SECTION"

          # Update PR description
          gh pr edit ${PR_NUMBER} --body "$NEW_BODY"
