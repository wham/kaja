name: demo
on:
  workflow_dispatch:
  pull_request:

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build . -t kaja-dev:latest --build-arg RUN_TESTS=true

      - name: Start Docker container
        run: |
          docker run --name kaja-dev -d -p 41520:41520 \
            -v $PWD/workspace:/workspace \
            kaja-dev:latest

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if docker logs kaja-dev 2>&1 | grep -q "Server started"; then
              echo "Server started!"
              break
            fi
            sleep 1
          done

      - name: Take demo video and screenshots
        id: demo
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          mkdir -p .github/demo
          node .github/scripts/take-demo.js

      - name: Convert video to GIF
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffmpeg -i .github/demo/demo.webm -vf "fps=10,scale=960:-1:flags=lanczos" -c:v gif .github/demo/demo.gif

      - name: Upload demo (artifact)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: demo
          path: .github/demo/

      - name: Post demo to PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"

          # Try GitHub's undocumented upload API (used by web UI)
          # First test with a smaller PNG to verify the API works
          echo "Attempting to upload PNG via GitHub uploads API..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/json" \
            -F "file=@.github/demo/home.png;type=image/png" \
            "https://uploads.github.com/repos/${REPO}/issues/${PR_NUMBER}/assets?name=home.png")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY"

          # Try to extract URL from response
          GIF_URL=$(echo "$BODY" | jq -r '.href // .url // .asset_url // empty' 2>/dev/null)

          if [ -n "$GIF_URL" ] && [ "$GIF_URL" != "null" ]; then
            echo "Upload successful! URL: $GIF_URL"
          else
            echo "Upload failed or URL not found in response"
            echo "Full response for debugging: $BODY"
            echo "$BODY" | jq . 2>/dev/null || echo "(not valid JSON)"
          fi

          # Post the response info as a comment for debugging
          echo "## ðŸŽ¬ Demo - Upload API Test" > /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "**HTTP Code:** $HTTP_CODE" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "**Response:**" >> /tmp/comment.md
          echo '```json' >> /tmp/comment.md
          echo "$BODY" >> /tmp/comment.md
          echo '```' >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "**Extracted URL:** $GIF_URL" >> /tmp/comment.md

          gh pr comment ${PR_NUMBER} --body-file /tmp/comment.md
