#!/bin/bash
set -e
cd "$(dirname "$0")/.."

# Kill background demo-app when the script exits
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

export GOBIN=$PWD/bin
export PATH=$GOBIN:$PATH
go install github.com/twitchtv/twirp/protoc-gen-twirp@latest
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

go build -o /tmp/demo-app ./cmd/demo-app
/tmp/demo-app &

# Remove files generated by protoc to have a clean state
rm error.txt || true
npx protoc --ts_out ./ui/src/gen --ts_opt long_type_string -I./proto $(find proto -iname "*.proto") 2> error.txt || true
(cd ./genpick && npm i && npm start)
(cd ./ui && npm i && npm start)