#!/bin/bash
set -e
cd "$(dirname "$0")/.."

# Kill background demo-app when the script exits
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

export GOBIN=$PWD/bin
export PATH=$GOBIN:$PATH
go install github.com/twitchtv/twirp/protoc-gen-twirp@latest
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

go build -o /tmp/protoc-gen-kaja-twirp ./cmd/protoc-gen-kaja-twirp/protoc-gen-kaja-twirp.go

# Remove files generated by protoc to have a clean state
rm kaja-twirp.json error.txt || true
protoc --proto_path=./proto --plugin=protoc-gen-kaja-twirp=/tmp/protoc-gen-kaja-twirp --kaja-twirp_out=. --go_out=. --twirp_out=. -Iproto/ $(find proto -iname "*.proto") 2> error.txt || true
# protoc --proto_path=./proto --plugin=protoc-gen-kaja-twirp=./plugin/bin/protoc-gen-kaja-twirp --kaja-twirp_out=. -Iproto/ $(find proto -iname "*.proto")

protoc --go_out=. ./internal/model/testdata.proto

go build -o /tmp/demo-app ./cmd/demo-app
/tmp/demo-app &

go build -o /tmp/kaja-twirp ./cmd/kaja-twirp/kaja-twirp.go
/tmp/kaja-twirp