#!/bin/bash
set -e

source "$(dirname "$0")/common"

# Parse arguments
BUILD_MODE=""
for arg in "$@"; do
    case $arg in
        --build=development)
            BUILD_MODE="development"
            shift
            ;;
        --build=distribution)
            BUILD_MODE="distribution"
            shift
            ;;
    esac
done

# Hardcoded signing profiles
DEVELOPMENT_PROFILE="Apple Development: Tomas Vesely (6C7UYVXQK7)"
DISTRIBUTION_PROFILE="Developer ID Application: Tomas Vesely (V4P5RN5L6R)"

# Check if Wails is installed, if not ask for user confirmation to install it using Homebrew
if ! command -v wails &> /dev/null
then
    echo "Wails is not installed."
    read -p "Would you like to install Wails using Homebrew? (y/n) " -n 1 -r
    echo    # Move to a new line
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        echo "Installing Wails using Homebrew..."
        brew install wails
    else
        echo "Wails installation skipped. Exiting script."
        exit 1
    fi
fi

setup_trap

cd "$(dirname "$0")/.."

export GOBIN=$PWD/server/build
export PATH=$GOBIN:$PATH

# Install protoc and Node.js
echo "Installing protoc..."
install_protoc
echo "Installing Node.js..."
install_nodejs

build_demo_apps
start_demo_apps

# Build UI assets
echo "Building UI..."
cd "./server"
go run cmd/build-ui/main.go

cd ".."

# Prepare desktop frontend assets
rm -rf desktop/frontend/dist || true
mkdir -p desktop/frontend/dist
cp server/build/main.css desktop/frontend/dist/main.css
cp server/build/main.js desktop/frontend/dist/main.js
cp -r server/static desktop/frontend/dist/
mv desktop/frontend/dist/static/index.html desktop/frontend/dist/index.html

cd "./desktop"

if [ -n "$BUILD_MODE" ]; then
    echo "Building desktop app ($BUILD_MODE)..."
    wails build

    APP_BUNDLE="./build/bin/kaja.app"
    if [ -d "$APP_BUNDLE" ]; then
        # Select signing profile based on build mode
        if [ "$BUILD_MODE" = "distribution" ]; then
            CODESIGN_IDENTITY="$DISTRIBUTION_PROFILE"
        else
            CODESIGN_IDENTITY="$DEVELOPMENT_PROFILE"
        fi

        ENTITLEMENTS="./build/darwin/entitlements.plist"
        echo "Signing app with: $CODESIGN_IDENTITY"
        codesign --force --options runtime --deep \
            --sign "$CODESIGN_IDENTITY" \
            --entitlements "$ENTITLEMENTS" \
            "$APP_BUNDLE"
        echo "App signed successfully"

        echo ""
        echo "Build complete: $APP_BUNDLE"
        open "$APP_BUNDLE"
    fi

    echo "Press Ctrl+C to stop demo apps and exit..."
    wait
else
    wails dev
fi
