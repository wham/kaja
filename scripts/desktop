#!/bin/bash
set -e

source "$(dirname "$0")/common"

# Parse arguments
BUILD_MODE=""
for arg in "$@"; do
    case $arg in
        --build=development)
            BUILD_MODE="development"
            shift
            ;;
        --build=distribution)
            BUILD_MODE="distribution"
            shift
            ;;
    esac
done

# Hardcoded signing profiles
DEVELOPMENT_PROFILE="Apple Development: Tomas Vesely (6C7UYVXQK7)"
DISTRIBUTION_PROFILE="Developer ID Application: Tomas Vesely (U5DMD247UW)"
NOTARY_PROFILE="kaja-notary"

# Check if Wails is installed
if ! command -v wails &> /dev/null
then
    if [ -t 0 ]; then
        echo "Wails is not installed."
        read -p "Would you like to install Wails using Homebrew? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Wails installation skipped. Exiting script."
            exit 1
        fi
    fi
    echo "Installing Wails using Homebrew..."
    brew install wails
fi

# Check if create-dmg is installed
if ! command -v create-dmg &> /dev/null
then
    if [ -t 0 ]; then
        echo "create-dmg is not installed."
        read -p "Would you like to install create-dmg using Homebrew? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "create-dmg installation skipped. Exiting script."
            exit 1
        fi
    fi
    echo "Installing create-dmg using Homebrew..."
    brew install create-dmg
fi

cd "$(dirname "$0")/.."

export GOBIN=$PWD/server/build
export PATH=$GOBIN:$PATH

# Install protoc and Node.js
echo "Installing protoc..."
install_protoc
echo "Installing Node.js..."
install_nodejs

# Install npm dependencies
if [ ! -d "ui/node_modules" ]; then
    echo "Installing npm dependencies..."
    (cd ui && npm ci)
fi

# Build UI assets
echo "Building UI..."
cd "./server"
go run cmd/build-ui/main.go

cd ".."

# Prepare desktop frontend assets
rm -rf desktop/frontend/dist || true
mkdir -p desktop/frontend/dist
cp server/build/main.css desktop/frontend/dist/main.css
cp server/build/main.js desktop/frontend/dist/main.js
cp server/build/monaco.*.worker.js desktop/frontend/dist/
cp -r server/static desktop/frontend/dist/
mv desktop/frontend/dist/static/index.html desktop/frontend/dist/index.html

cd "./desktop"

if [ "$BUILD_MODE" = "development" ] || [ "$BUILD_MODE" = "distribution" ]; then
    # For distribution builds, update wails.json with git tag version
    if [ "$BUILD_MODE" = "distribution" ]; then
        GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
        if [ -n "$GIT_TAG" ]; then
            echo "Setting productVersion to git tag: $GIT_TAG"
            # Update productVersion in wails.json using jq
            jq --arg version "$GIT_TAG" '.info.productVersion = $version' wails.json > wails.json.tmp && mv wails.json.tmp wails.json

            # Commit and push the version update
            git add wails.json
            git commit -m "Update productVersion to $GIT_TAG"
            git push origin "$GIT_TAG"

            # Use tag as GitRef for distribution
            GIT_REF="$GIT_TAG"
        else
            echo "Warning: No git tag found, using default version from wails.json"
            GIT_REF=$(git rev-parse HEAD 2>/dev/null || echo "")
        fi
    else
        # Development build mode - use git hash
        GIT_REF=$(git rev-parse HEAD 2>/dev/null || echo "")
    fi

    echo "Building desktop app ($BUILD_MODE)..."
    wails build -ldflags "-X main.GitRef=$GIT_REF"

    APP_BUNDLE="./build/bin/Kaja.app"
    if [ -d "$APP_BUNDLE" ]; then
        # Select signing profile based on build mode
        if [ "$BUILD_MODE" = "distribution" ]; then
            CODESIGN_IDENTITY="$DISTRIBUTION_PROFILE"
        else
            CODESIGN_IDENTITY="$DEVELOPMENT_PROFILE"
        fi

        ENTITLEMENTS="./build/darwin/entitlements.plist"
        echo "Signing app with: $CODESIGN_IDENTITY"
        if codesign --force --options runtime --deep \
            --sign "$CODESIGN_IDENTITY" \
            --entitlements "$ENTITLEMENTS" \
            "$APP_BUNDLE" 2>/dev/null; then
            echo "App signed successfully"
        else
            echo "Signing skipped (certificate not available)"
        fi

        if [ "$BUILD_MODE" = "distribution" ]; then
            echo ""
            echo "Notarizing app..."
            APP_ZIP="./build/bin/Kaja.zip"

            # Create zip for notarization
            ditto -c -k --keepParent "$APP_BUNDLE" "$APP_ZIP"

            # Submit for notarization and wait
            xcrun notarytool submit "$APP_ZIP" \
                --keychain-profile "$NOTARY_PROFILE" \
                --wait

            # Staple the notarization ticket
            echo "Stapling notarization ticket..."
            xcrun stapler staple "$APP_BUNDLE"

            # Clean up
            rm "$APP_ZIP"

            echo "App notarization complete"
        fi

        # Create DMG
        echo ""
        echo "Creating DMG..."
        DMG_PATH="./build/bin/Kaja.dmg"
        rm -f "$DMG_PATH"

        if [ "$BUILD_MODE" = "distribution" ]; then
            create-dmg \
                --volname "Kaja" \
                --volicon "./build/appicon.png" \
                --window-size 600 400 \
                --icon-size 100 \
                --icon "Kaja.app" 150 200 \
                --app-drop-link 450 200 \
                "$DMG_PATH" \
                "$APP_BUNDLE"

            # Notarize DMG
            echo ""
            echo "Notarizing DMG..."
            xcrun notarytool submit "$DMG_PATH" \
                --keychain-profile "$NOTARY_PROFILE" \
                --wait

            # Staple DMG
            echo "Stapling DMG..."
            xcrun stapler staple "$DMG_PATH"

            echo ""
            echo "Distribution complete: $DMG_PATH"
        else
            # create-dmg returns exit code 1 when it can't sign (expected without certificates)
            create-dmg \
                --volname "Kaja" \
                --window-size 600 400 \
                --icon-size 100 \
                --icon "Kaja.app" 150 200 \
                --app-drop-link 450 200 \
                "$DMG_PATH" \
                "$APP_BUNDLE" \
                || true

            if [ -f "$DMG_PATH" ]; then
                echo "DMG created: $DMG_PATH"
            else
                echo "Failed to create DMG"
                exit 1
            fi
        fi

        echo ""
        echo "Build complete: $APP_BUNDLE"
        if [ -t 0 ]; then
            open "$APP_BUNDLE"
        fi
    fi

else
    # Dev mode - use git hash
    GIT_REF=$(git rev-parse HEAD 2>/dev/null || echo "")
    wails dev -ldflags "-X main.GitRef=$GIT_REF"
fi
