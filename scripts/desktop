#!/bin/bash
set -e

source "$(dirname "$0")/common"

# Parse arguments
PROD_MODE=false
for arg in "$@"; do
    case $arg in
        --prod)
            PROD_MODE=true
            shift
            ;;
    esac
done

# Check if Wails is installed, if not ask for user confirmation to install it using Homebrew
if ! command -v wails &> /dev/null
then
    echo "Wails is not installed."
    read -p "Would you like to install Wails using Homebrew? (y/n) " -n 1 -r
    echo    # Move to a new line
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        echo "Installing Wails using Homebrew..."
        brew install wails
    else
        echo "Wails installation skipped. Exiting script."
        exit 1
    fi
fi

setup_trap

cd "$(dirname "$0")/.."

export GOBIN=$PWD/server/build
export PATH=$GOBIN:$PATH

# Install protoc and Node.js
echo "Installing protoc..."
install_protoc
echo "Installing Node.js..."
install_nodejs

build_demo_apps
start_demo_apps

# Build UI assets
echo "Building UI..."
cd "./server"
go run cmd/build-ui/main.go

cd ".."

# Prepare desktop frontend assets
rm -rf desktop/frontend/dist || true
mkdir -p desktop/frontend/dist
cp server/build/main.css desktop/frontend/dist/main.css
cp server/build/main.js desktop/frontend/dist/main.js
cp -r server/static desktop/frontend/dist/
mv desktop/frontend/dist/static/index.html desktop/frontend/dist/index.html

cd "./desktop"

if [ "$PROD_MODE" = true ]; then
    echo "Building desktop app..."
    wails build

    APP_BUNDLE="./build/bin/desktop.app"
    if [ -d "$APP_BUNDLE" ]; then
        # Sign the app for distribution
        # Use CODESIGN_IDENTITY env var, or default to local development cert
        CODESIGN_IDENTITY="${CODESIGN_IDENTITY:-Apple Development: Tomas Vesely (6C7UYVXQK7)}"
        ENTITLEMENTS="./build/darwin/entitlements.plist"
        echo "Signing app with: $CODESIGN_IDENTITY"
        codesign --force --options runtime --deep \
            --sign "$CODESIGN_IDENTITY" \
            --entitlements "$ENTITLEMENTS" \
            "$APP_BUNDLE"
        echo "App signed successfully"

        echo ""
        echo "Build complete: $APP_BUNDLE"
        open "$APP_BUNDLE"
    fi

    echo "Press Ctrl+C to stop demo apps and exit..."
    wait
else
    wails dev
fi
