#!/bin/bash
set -e

# Post-build hook for wails desktop app
# Called from desktop/build/bin directory with ${bin} as argument
# Copies protoc, protoc-gen-ts, node, include files, and demo resources into the app bundle

BIN_PATH="$1"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR/.."
SERVER_BUILD="$PROJECT_ROOT/server/build"
WORKSPACE="$PROJECT_ROOT/workspace"

# Derive app bundle path from binary path (e.g., ./Kaja.app/Contents/MacOS/Kaja -> ./Kaja.app)
if [[ "$BIN_PATH" == *.app/Contents/MacOS/* ]]; then
    APP_BUNDLE="${BIN_PATH%/Contents/MacOS/*}"
elif [[ -d "${BIN_PATH}.app" ]]; then
    APP_BUNDLE="${BIN_PATH}.app"
else
    echo "Not a macOS app bundle build, skipping post-build hook"
    exit 0
fi

if [ ! -d "$APP_BUNDLE" ]; then
    echo "App bundle not found: $APP_BUNDLE"
    exit 1
fi

echo "Bundling protoc and node into $APP_BUNDLE..."

MACOS_DIR="$APP_BUNDLE/Contents/MacOS"
RESOURCES_DIR="$APP_BUNDLE/Contents/Resources"

# Copy executables to MacOS directory
rm -f "$MACOS_DIR/protoc" "$MACOS_DIR/protoc-gen-ts" "$MACOS_DIR/node"
cp "$SERVER_BUILD/protoc" "$MACOS_DIR/"
cp "$SERVER_BUILD/protoc-gen-ts" "$MACOS_DIR/"
cp "$SERVER_BUILD/node" "$MACOS_DIR/"

# Copy include files (well-known types) to Resources
rm -rf "$RESOURCES_DIR/include"
cp -r "$SERVER_BUILD/include" "$RESOURCES_DIR/"

# Copy demo resources to Resources/demo (excluding quirks)
echo "Bundling demo resources..."
DEMO_DIR="$RESOURCES_DIR/demo"
rm -rf "$DEMO_DIR"
mkdir -p "$DEMO_DIR"

# Copy proto directories from workspace (teams and users only)
cp -r "$WORKSPACE/teams" "$DEMO_DIR/"
cp -r "$WORKSPACE/users" "$DEMO_DIR/"

# Filter out quirks projects and create demo kaja.json
cat "$WORKSPACE/kaja.json" | \
    jq 'del(.ai) | del(.system) | .projects = [.projects[] | select(.name | contains("quirks") | not)]' \
    > "$DEMO_DIR/kaja.json"

echo "Post-build complete: bundled protoc, protoc-gen-ts, node, demo into $APP_BUNDLE"
