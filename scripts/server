#!/bin/bash
set -e

source "$(dirname "$0")/common"

cd "$(dirname "$0")/.."

# Install protoc to server/build using npm package
install_protoc() {
    local INSTALL_DIR="$PWD/server/build"

    if [ -x "$INSTALL_DIR/protoc" ]; then
        echo "protoc already installed at $INSTALL_DIR/protoc"
        return 0
    fi

    echo "Installing protoc via npm..."
    mkdir -p "$INSTALL_DIR"

    # Install npm protoc package
    npm install protoc --save-dev

    # Determine platform-specific binary
    local OS="$(uname -s)"
    local ARCH="$(uname -m)"
    local PROTOC_BIN

    case "$OS" in
        Darwin) PROTOC_BIN="protoc-osx" ;;
        Linux)  PROTOC_BIN="protoc-linux" ;;
        *)      echo "Error: Unsupported OS: $OS"; exit 1 ;;
    esac

    case "$ARCH" in
        arm64|aarch64) PROTOC_BIN="${PROTOC_BIN}-aarch_64" ;;
        x86_64)        PROTOC_BIN="${PROTOC_BIN}-x86_64" ;;
        *)             echo "Error: Unsupported architecture: $ARCH"; exit 1 ;;
    esac

    # Create bin subdirectory and copy protoc there
    mkdir -p "$INSTALL_DIR/bin"
    cp "./node_modules/protoc/bin/${PROTOC_BIN}" "$INSTALL_DIR/bin/protoc"
    chmod +x "$INSTALL_DIR/bin/protoc"

    # Copy include files (protoc looks for ../include relative to binary)
    cp -r "./node_modules/protoc/include" "$INSTALL_DIR/"

    # Create wrapper script at expected location
    cat > "$INSTALL_DIR/protoc" << 'EOF'
#!/bin/bash
exec "$(dirname "$0")/bin/protoc" "$@"
EOF
    chmod +x "$INSTALL_DIR/protoc"

    echo "protoc installed to $INSTALL_DIR/protoc"
}

install_protoc

setup_trap

[ -f .ai_api_key ] && export AI_API_KEY=$(cat .ai_api_key)

export GOBIN=$PWD/server/build
export PATH=$GOBIN:$PATH
go install github.com/twitchtv/twirp/protoc-gen-twirp@latest
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

cd "./ui"
npm i
npm run protoc

cd ..
build_demo_apps
start_demo_apps

cd "server"
go run cmd/build-ui/main.go
protoc --proto_path=. --plugin=protoc-gen-go=./build/protoc-gen-go --go_out=. --plugin=protoc-gen-twirp=./build/protoc-gen-twirp --twirp_out=. -Iproto/ $(find . -iname "*.proto" -not -path './build/include/*')
go build -tags development -o /tmp/kaja ./cmd/server
AI_API_KEY=$AI_API_KEY /tmp/kaja
