#!/bin/bash
set -e

source "$(dirname "$0")/common"

# Check if Go is installed, if not ask for user confirmation to install it using Homebrew
if ! command -v go &> /dev/null
then
    echo "Go is not installed."
    read -p "Would you like to install Go using Homebrew? (y/n) " -n 1 -r
    echo    # Move to a new line
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        echo "Installing Go using Homebrew..."
        brew install go
    else
        echo "Go installation skipped. Exiting script."
        exit 1
    fi
fi

cd "$(dirname "$0")/.."

# Kill any existing server on port 41520
lsof -ti:41520 | xargs kill 2>/dev/null || true

export GOBIN=$PWD/server/build
export PATH=$GOBIN:$PATH

# Install protoc to server/build
install_protoc
go install github.com/twitchtv/twirp/protoc-gen-twirp@latest
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

# Build protoc-gen-kaja
go build -C protoc-gen-kaja -o $PWD/server/build/protoc-gen-kaja .

# Generate UI proto client code using protoc-gen-kaja
protoc --plugin=protoc-gen-kaja=server/build/protoc-gen-kaja --kaja_out=ui/src/server --proto_path=server/proto api.proto

cd "./ui"
npm i

cd ../server
go run cmd/build-ui/main.go
protoc --proto_path=. --plugin=protoc-gen-go=./build/protoc-gen-go --go_out=. --plugin=protoc-gen-twirp=./build/protoc-gen-twirp --twirp_out=. -Iproto/ $(find proto -iname "*.proto")
mkdir -p /tmp/kaja
GIT_REF=$(git rev-parse HEAD 2>/dev/null || echo "")
go build -tags development -ldflags "-X main.GitRef=$GIT_REF" -o /tmp/kaja/kaja ./cmd/server
/tmp/kaja/kaja
