syntax = "proto3";

option go_package = "pkg/api";

service Api {
  rpc Compile(CompileRequest) returns (CompileResponse);
  rpc Reflect(ReflectRequest) returns (ReflectResponse);
  rpc GetConfiguration(GetConfigurationRequest) returns (GetConfigurationResponse);
  rpc UpdateConfiguration(UpdateConfigurationRequest) returns (UpdateConfigurationResponse);
  rpc ChatCompletions(ChatCompletionsRequest) returns (ChatCompletionsResponse);
}

message CompileRequest {
  string id = 1;
  int32 log_offset = 2;
  string proto_dir = 3;
  repeated string proto_files = 4;
}

message ReflectRequest {
  string url = 1;  // Target gRPC server URL for reflection discovery
}

message ReflectResponse {
  ReflectStatus status = 1;
  repeated Log logs = 2;
  string proto_dir = 3;  // Temp directory containing discovered proto files (only set on success)
}

enum ReflectStatus {
  REFLECT_STATUS_UNKNOWN = 0;
  REFLECT_STATUS_OK = 1;
  REFLECT_STATUS_ERROR = 2;
}

message CompileResponse {
  CompileStatus status = 1;
  repeated Log logs = 2;
  repeated Source sources = 3;
  string stub = 4;
}

enum CompileStatus {
  STATUS_UNKNOWN = 0;
  STATUS_READY = 1;
  STATUS_ERROR = 2;
  STATUS_RUNNING = 3;
}

message Log {
  LogLevel level = 1;
  string message = 2;
}

enum LogLevel {
  LEVEL_DEBUG = 0;
  LEVEL_INFO = 1;
  LEVEL_WARN = 2;
  LEVEL_ERROR = 3;
}

enum RpcProtocol {
  RPC_PROTOCOL_TWIRP = 0;
  RPC_PROTOCOL_GRPC = 1;
}

message Source {
  string path = 1;
  string content = 2;
}

message GetConfigurationRequest {}

message GetConfigurationResponse {
  Configuration configuration = 1;
  repeated Log logs = 2;
}

message Configuration {
  // kaja can be deployed at a subpath - i.e. kaja.tools/demo
	// This field is used to set the subpath.
	// The server uses it to generate the correct paths in HTML and redirects.
	// The JS code is using relative paths and should be not dependent on this.
  string path_prefix = 1;
  repeated ConfigurationProject projects = 2;
  ConfigurationAI ai = 3;
  // System-level settings (read-only, ignored in UpdateConfiguration)
  ConfigurationSystem system = 4;
}

message ConfigurationSystem {
  // Whether the UI can update configuration (true in desktop app, false in web server)
  bool can_update_configuration = 1;
}

message ConfigurationProject {
  string name = 1;
  RpcProtocol protocol = 2;
  string url = 3;
  string proto_dir = 4;
  bool use_reflection = 5;
  repeated string proto_files = 6;
}

message ConfigurationAI {
  string base_url = 1;
  string api_key = 2;
}

message UpdateConfigurationRequest {
  Configuration configuration = 1;
}

message UpdateConfigurationResponse {
  Configuration configuration = 1;
}

// ChatCompletions mimics the OpenAI Chat Completions API
// https://platform.openai.com/docs/api-reference/chat/create

message ChatCompletionsRequest {
  string model = 1;
  repeated ChatMessage messages = 2;
  double temperature = 3;
  double top_p = 4;
  int32 max_tokens = 5;
  repeated string stop = 6;  // Stop sequences to halt generation
}

message ChatMessage {
  string role = 1;    // "system", "user", "assistant"
  string content = 2;
}

message ChatCompletionsResponse {
  string id = 1;
  string model = 2;
  repeated ChatChoice choices = 3;
  ChatUsage usage = 4;
  string error = 5;  // Non-empty if there was an error
}

message ChatChoice {
  int32 index = 1;
  ChatMessage message = 2;
  string finish_reason = 3;  // "stop", "length", etc.
}

message ChatUsage {
  int32 prompt_tokens = 1;
  int32 completion_tokens = 2;
  int32 total_tokens = 3;
}