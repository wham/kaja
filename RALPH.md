## Task

You are porting [protoc-gen-ts](https://github.com/timostamm/protobuf-ts/tree/main/packages/plugin) to Go plugin `protoc-gen-kaja`. The Go implementation must produce **byte-for-byte identical output** to the TypeScript original. No exceptions. No "close enough".

## How This Works

You are running inside an automated loop. **Each invocation is stateless** — you have no memory of previous runs. This file (RALPH.md) is your only persistent memory. Read it first. Write to it before you finish. Your future self depends on it.

## Steps (follow this order every run)

1. **Read state.** Read the [Plan](#plan) and [Notes](#notes) sections below. Understand where you left off. Don't redo work that's already done.
2. **Orient.** If Plan is empty, analyze the codebase, research the TS plugin (clone it if needed), and write a detailed plan. If Plan exists, pick the next incomplete item.
3. **Implement.** Spend the bulk of your effort here. Work on ONE failing test case or feature at a time. Make real, substantive progress.
4. **Test.** Run the tests. Read the output carefully. If a test fails, understand WHY before changing code.
5. **Update memory.** Update [Plan](#plan) with what's done and what's next. Update [Notes](#notes) with learnings that will help future runs. Be specific — file paths, function names, gotchas, how to run tests.
6. **Commit.** One-line past-tense message summarizing what changed.
7. **Check completion.** If ALL tests pass, write "DONE" to /status.txt and stop. If any test fails, do NOT write DONE. Just end — you'll run again.

## Rules

- **DONE means ALL tests pass.** Not most. Not "the important ones". ALL. Zero failures.
- **Never weaken requirements.** Don't modify test expectations. Don't skip tests. Don't add notes like "close enough" or "cosmetic difference". If you see such notes below, delete them.
- **Never mark DONE prematurely.** Run the full test suite and confirm zero failures before writing DONE.
- **Be bold with architecture.** If the current approach is fundamentally wrong, refactor it. Document why in the plan.
- **Keep Notes actionable.** Good: "Run tests with `protoc-gen-kaja/scripts/test`. Failures show as diffs." Bad: "Making good progress overall."
- **One thing at a time.** Fix one test, commit, move to the next. Don't try to fix everything in one run.

## Plan

- [x] Fix test 79_only_imports: Skip WKT generation when no FileToGenerate produced output
- [x] Verify test 61_imported_method_options still passes (transitive WKT deps)
- [x] All 85/85 tests passing
- [x] Fix test 82_map_scalar_value_types: getMapValueWriter now delegates to getWireType+getWriterMethodName instead of hardcoding only 4 types
- [x] All 86/86 tests passing
- [x] Fix test 83_map_fixed_key_types: Simplified getMapKeyWriter to reuse getWireType+getWriterMethodName
- [x] Fix test 84_map_message_value_fixed_keys: Message-value map write path now uses getMapKeyWriter for proper wire types/methods instead of hardcoding Varint/int32
- [x] All 88/88 tests passing
- [x] Fix test 85_proto2_required_message: Required message fields in proto2 should still generate optional TS properties (`?:`)
- [x] Fix test 86_proto2_oneof: Proto2 oneof member fields should not show `optional` label in comments
- [x] All 90/90 tests passing
- [x] Fix test 87_oneof_json_name: Added json_name annotation to oneof field comments and jsonName property to scalar oneof field info entries
- [x] All 91/91 tests passing
- [x] Fix test 88_oneof_deprecated: Added @deprecated JSDoc tag and [deprecated = true] annotation for deprecated oneof member fields
- [x] All 92/92 tests passing
- [x] Fix test 89_oneof_jstype: Added jstype annotation (`[jstype = JS_NUMBER]`/`[jstype = JS_STRING]`) to oneof member field `@generated` comments
- [x] All 93/93 tests passing
- [x] Fix test 90_map_underscore_message: Used `protoName` instead of `strings.ReplaceAll(fullName, "_", ".")` for map error messages, since message names can contain underscores
- [x] Fix test 91_nested_oneof_comment: Pass msg descriptor and full msgPath to generateOneofField instead of just msgIndex, so nested message oneofs use correct source locations
- [x] Fix test 92_proto2_oneof_default: Added default value annotation (`[default = ...]`) to oneof member field `@generated` interface comments
- [x] All 96/96 tests passing
- [x] Fix test 93_oneof_trailing_blank_comment: Added __HAS_TRAILING_BLANK__ marker handling to oneof and oneof-field comment generation, matching the pattern used elsewhere
- [x] Fix test 94_enum_value_trailing_blank_comment: Added enum trailing comments support and __HAS_TRAILING_BLANK__ handling for enum value leading comments
- [x] All 98/98 tests passing
- [x] Fix test 95_proto2_oneof_enum: Proto2 oneof enum members should not get `opt: true` — added `field.OneofIndex == nil` check
- [x] All 99/99 tests passing
- [x] Fix test 96_service_trailing_blank_comment: Service and method comments in client file need `hasTrailingBlank` conditional (two `*` lines instead of one)
- [x] All 100/100 tests passing
- [x] Fix test 97_oneof_detached_comment: Added leading detached comments support for oneof declarations, same pattern as regular fields
- [x] Fix test 98_oneof_member_detached_comment: Oneof trailing comment (from `oneof` declaration path) goes into the oneof JSDoc; non-first member field detached comments go as `//` before the field JSDoc
- [x] All 102/102 tests passing
- [x] Fix test 99_service_first_method_detached: Removed `methodIdx > 0` guard on detached comment output for service methods — first method's detached comments were being skipped
- [x] All 103/103 tests passing
- [x] Fix test 100_oneof_kind_field_escape: Added `oneofKind` to the list of reserved property names that get `$` suffix escaping (alongside `__proto__` and `toString`), matching protobuf-ts's `oneofKindDiscriminator` collision handling
- [x] Fix test 101_service_detached_comment: Added service-level LeadingDetachedComments as `//` line comments before JSDoc blocks for both the interface and implementation class in generateServiceClient
- [x] Fix test 102_oneof_name_escape: Added `oneofKind` to the oneof name escaping check (alongside `__proto__` and `toString`) in all 5 locations where oneofCamelName is computed
- [x] Fix test 103_field_detached_comment_blank: Detached comment blank lines within a block should use `// ` (with trailing space), and separators between blocks should be empty lines (not `//`). Fixed in 6 locations: field, oneof, oneof member, and service (interface + implementation).
- [x] Fix test 104_service_method_detached_blocks: Added empty line separators between multiple detached comment blocks for service methods (both interface and implementation), matching the pattern used by field detached comments
- [x] Fix test 105_file_detached_comment_blank: File-level detached comments (first message) need `// ` (with trailing space) for blank lines within blocks and empty lines between blocks, same pattern as field/service detached comments. Note: the file-header license comment section (syntax path 12) uses `//` (no trailing space) — do NOT change those.
- [x] Fix test 106_enum_detached_comment: Added leading detached comments support for enum declarations, same pattern as message/field/oneof detached comments — `//` style before JSDoc with `// ` for blank lines and empty separators between blocks
- [x] All 110/110 tests passing
- [x] Fix test 107_deprecated_file_oneof: Added `@deprecated` to oneof JSDoc when file has `option deprecated = true`
- [x] All 111/111 tests passing
- [x] Fix test 108_field_multi_options: Combined separate `[opt]` brackets into single `[opt1, opt2, ...]` format using `formatFieldOptionsAnnotation` helper. Fixed WireType import ordering by generalizing `wireTypeVeryLate` condition.
- [x] All 112/112 tests passing
- [x] Fix test 109_message_trailing_comment: Added message trailing comment support to interface JSDoc, same pattern as enum trailing comments — use `getEnumTrailingComments` (preserves trailing blank info) and insert between leading comments and `@generated` tag
- [x] Fix test 110_service_trailing_comment: Added trailing comment support to service and method JSDoc in generateServiceClient — 4 locations (service interface, service class, method interface, method class) using getEnumTrailingComments pattern
- [x] All 114/114 tests passing
- [x] Fix test 111_client_streaming_first_unary_import: When method 0 is streaming and later methods are unary, UnaryCall import must appear before stackIntercept (matching protobuf-ts prepend order)
- [x] All 115/115 tests passing
- [x] Fix test 112_string_default_with_quotes: String/bytes default values use `strings.Replace(val, `"`, `\"`, 1)` (first match only) to match protobuf-ts's `String.replace` behavior. Removed unused `escapeForTypeScriptStringLiteral` function.
- [x] All 116/116 tests passing
- [x] Fix test 113_jstype_normal: Added `jstype = JS_NORMAL` support — explicit JS_NORMAL on 64-bit integer fields overrides `long_type_string` parameter to use `bigint` type, `0n` default, `.toBigInt()` reader, `L: 0 /*LongType.BIGINT*/` descriptor param, and `[jstype = JS_NORMAL]` annotation
- [x] All 117/117 tests passing
- [x] Fix test 114_optimize_code_size: Added `optimize_for = CODE_SIZE` support — skip `create()`, `internalBinaryRead()`, `internalBinaryWrite()` methods and their imports (BinaryWriteOptions, IBinaryWriter, WireType, BinaryReadOptions, IBinaryReader, UnknownFieldHandler, PartialMessage, reflectionMergePartial)
- [x] Fix test 115_optimize_lite_runtime: `optimize_for = LITE_RUNTIME` behaves same as CODE_SIZE — extended `isOptimizeCodeSize()` to also check for `LITE_RUNTIME`
- [x] Fix test 116_string_default_cr: String default values with `\r` (CR) chars must be converted to `\n` (LF) to match TypeScript printer's newline normalization. Modified `g.p()` to handle embedded newlines by adding indent to continuation lines.
- [x] All 120/120 tests passing
- [x] Fix test 117_string_default_newline: JSDoc continuation lines after `\n` in string defaults need ` * ` prefix, but `\r`→`\n` conversions do NOT. Moved `\r`→`\n` from formatDefaultValueAnnotation into g.p() to distinguish the two cases.
- [x] All 121/121 tests passing
- [x] Fix test 118_streaming_only_service: When all service methods are streaming, section 3 (streaming call type imports) was duplicating section 5 (method 0 call type). Added `method0CallType` tracking to skip method 0's call type from section 3 emission.
- [x] All 122/122 tests passing
- [x] Fix test 119_mixed_streaming_unary_import: When method 0 is streaming and later methods are unary, UnaryCall must appear ABOVE other streaming call types (not below). Moved UnaryCall emission to before section 3's streaming call types, computed within the first-service block using `hasUnaryInService` check.
- [x] All 123/123 tests passing
- [x] Fix test 120_custom_message_options: Refactored custom option parsing into shared `buildExtensionMap`/`parseCustomOptions` functions, added `getCustomMessageOptions` for MessageOptions, and passed custom message options as third argument to MessageType constructor's `super()` call
- [x] All 124/124 tests passing
- [x] Fix test 121_enum_alias_deprecated: Enum aliases should use the original value's deprecated status, not the alias's own. Changed deprecation check to look at `enum.Value[firstValueIndexForNumber[...]]` when `isAlias` is true.
- [x] Fix test 122_custom_field_options: Added `getCustomFieldOptions` (like `getCustomMethodOptions`/`getCustomMessageOptions`) and included `options: { ... }` in field descriptor output when custom field options are present
- [x] Fix test 123_custom_service_options: Added `getCustomServiceOptions` (like `getCustomMessageOptions`) and included custom service options as third argument to ServiceType constructor
- [x] All 127/127 tests passing
- [x] Fix test 124_oneof_member_trailing_comment: Added trailing comment support for oneof member fields — append `// <comment>` after the property declaration in the interface when field has a trailing comment
- [x] Fix test 125_service_import_order: Service-only file imports need per-method-pair reversal (not element-level) to match protobuf-ts prepend semantics — output stays above input within each method, but later methods appear above earlier methods
- [x] Fix test 126_method_option_key_quoting: Custom option keys without dots (no package prefix) should be unquoted in TS object literals; only dot-containing keys (e.g. `"test.resource_name"`) get quoted
- [x] Fix test 127_custom_enum_type_option: Added TYPE_ENUM handling to parseCustomOptions — reads varint value, resolves to enum value name via resolveEnumValueName helper that searches all files (including nested enums in messages)
- [x] All 132/132 tests passing
- [x] Fix test 128_custom_float_option: Added TYPE_FLOAT and TYPE_DOUBLE handling to parseCustomOptions — decode Fixed32/Fixed64 wire values using math.Float32frombits/Float64frombits and store as float64. Added float64 case to formatCustomOptions using strconv.FormatFloat.
- [x] Fix test 129_custom_sint_option: Added TYPE_SINT32/SINT64 (zigzag-decoded), TYPE_SFIXED32/SFIXED64 (fixed-width signed), and TYPE_FIXED32/FIXED64 (fixed-width unsigned) handling to parseCustomOptions
- [x] Fix test 130_custom_message_type_option: Added TYPE_MESSAGE handling to parseCustomOptions — recursively decodes message wire bytes using findMessageType + new parseMessageValue helper, outputs nested object via formatCustomOptions recursion
- [x] All 135/135 tests passing
- [x] Fix test 131_repeated_custom_option: Repeated custom option extensions must be merged into arrays — added `mergeRepeatedOptions` post-processing in `parseCustomOptions` and `formatCustomOptionArray` for `[]interface{}` output
- [x] Fix test 132_custom_bytes_option: Added TYPE_BYTES handling to parseCustomOptions and parseMessageValue — reads bytes wire value and encodes as base64 string using `base64.StdEncoding.EncodeToString`
- [x] Fix test 133_custom_int64_option: 64-bit integer custom option values (int64, uint64, sint64, fixed64, sfixed64) must be formatted as quoted strings per protobuf JSON mapping spec — split from 32-bit counterparts in both parseCustomOptions and parseMessageValue
- [x] Fix test 134_nested_repeated_option: Applied `mergeRepeatedOptions` to `parseMessageValue` return value — repeated fields inside nested message options were producing duplicate keys instead of arrays
- [x] Fix test 135_custom_option_string_escape: Escaped double quotes inside custom option string values using `strings.ReplaceAll(val, `"`, `\"`)` in both `formatCustomOptions` and `formatCustomOptionArray`
- [x] Fix test 136_custom_option_string_backslash: Backslashes in custom option string values must be escaped as `\\` before quote escaping — added `strings.ReplaceAll(val, `\`, `\\`)` before `"` escaping in both `formatCustomOptions` and `formatCustomOptionArray`
- [x] Fix test 137_custom_option_string_newline: Newline (`\n`) and carriage return (`\r`) characters in custom option string values must be escaped as `\\n`/`\\r` in generated JS string literals — added escaping after backslash/quote escaping in both `formatCustomOptions` and `formatCustomOptionArray`
- [x] Fix test 138_custom_message_option_json_name: Used `fd.GetJsonName()` instead of `fd.GetName()` in `parseMessageValue` — message-typed custom option fields should use camelCase JSON names (e.g., `displayName`) not proto snake_case names (e.g., `display_name`)
- [x] Fix test 139_nested_extension_option: Extended `buildExtensionMap` to scan extensions nested inside messages (via `msg.Extension`) recursively, not just top-level `file.Extension`. Added `msgPrefix` to `extInfo` struct so nested extension names include parent message name (e.g., `test.Extensions.searchable` instead of `test.searchable`).
- [x] All 144/144 tests passing
- [x] Fix test 140_custom_float_scientific_notation: Added `formatFloatJS` helper that matches JavaScript's `Number.prototype.toString()` — scientific notation for |v| < 1e-6 or |v| >= 1e21, fixed-point otherwise. Replaced `strconv.FormatFloat(val, 'f', -1, 64)` in both `formatCustomOptions` and `formatCustomOptionArray`.
- [x] Fix test 141_custom_float_nan_infinity: NaN, +Inf, and -Inf float/double values in custom options must be stored as strings ("NaN", "Infinity", "-Infinity") so they're output as quoted JS strings, matching protobuf-ts's JSON serialization of special float values
- [x] All 146/146 tests passing
- [x] Fix test 142_custom_map_option: Map fields in custom message options must be serialized as plain objects ({ key1: value1 }) not arrays of entries. Added mapEntryValue struct and detection of GetMapEntry() in parseMessageValue's TYPE_MESSAGE case. Updated mergeRepeatedOptions to merge map entries into []customOption (object format).
- [x] All 147/147 tests passing
- [x] Fix test 143_custom_map_int_key: Integer map keys in custom options must be quoted strings (`"1": "one"` not `1: "one"`) per JSON mapping spec. Added numeric key type detection in parseMessageValue's map entry handling — wraps key in `"..."` when key field type is any integer type.
- [x] Fix test 144_custom_map_digit_key: String map keys starting with a digit (e.g. `123abc`) must be quoted in JS object literals since they aren't valid JS identifiers. Extended `formatCustomOptions` key quoting to also check `opt.key[0] >= '0' && opt.key[0] <= '9'`.
- [x] All 149/149 tests passing
- [x] Fix test 145_custom_option_packed_repeated: Added packed repeated encoding handling to parseMessageValue — when wire type is BytesType for repeated scalar fields, reads packed bytes and decodes all contained values individually (varint, fixed32, fixed64 formats)
- [x] All 150/150 tests passing
- [x] Fix test 146_empty_service: Empty services (no methods) need two fixes: (1) skip RpcOptions import when no methods exist, (2) output `[]` on same line as ServiceType constructor instead of `[\n]`
- [x] All 151/151 tests passing
- [x] Fix test 147_enum_trailing_underscore_prefix: Enum prefix detection must unconditionally append `_` after UPPER_SNAKE_CASE conversion (protobuf-ts always appends `_`). Our code was using `HasSuffix("_")` guard which skipped the extra `_` for enum names ending with `_` (e.g., `MyEnum_` → `MY_ENUM_` instead of correct `MY_ENUM__`)
- [x] All 152/152 tests passing
- [x] Fix test 148_enum_underscore_prefix: Enum prefix detection for names starting with `_` (e.g., `_Foo`) must match protobuf-ts: prepend `_` before ALL uppercase, strip leading `_`, uppercase, append `_`. Our code skipped prepending at i=0, producing `__FOO_` instead of `_FOO_`.
- [x] All 153/153 tests passing
- [x] Fix test 149_multi_server_streaming_import: When multiple non-method-0 streaming methods share the same call type, only emit the import at the last occurrence in streamingMethods (which corresponds to the first registration in protobuf-ts's prepend model). Used `lastCallTypeIdx` map to track where each call type should be emitted.
- [x] All 154/154 tests passing
- [x] Fix test 150_client_import_streaming_interleave: Unified streaming and non-streaming import collection into single ordered list with forward-pass `firstMethodForType` map to correctly position type imports relative to streaming call types
- [x] All 155/155 tests passing
- [x] Fix test 151_oneof_underscore_name: Replaced heuristic proto3 optional detection (name starts with `_`, 1 field, name match) with `field.Proto3Optional` check in all 5 locations. The heuristic misidentified real oneofs named `_value` as synthetic proto3 optional fields.
- [x] Fix test 152_duplicate_property_create: When two proto fields resolve to the same camelCase TS property name (e.g. `x123y` and `x_123_y` → `x123Y`), the `create()` method should only initialize the property once. Added `fieldNameSeen` deduplication after collecting initItems.
- [x] Fix test 153_package_detached_comment: Added package-level detached comments (path [2]) to file header output, same pattern as syntax detached comments (path [12])
- [x] All 158/158 tests passing — DONE
- [x] Fix test 154_import_name_collision: Added import name collision detection — when an imported type name collides with a locally defined type name, the import is aliased with `$` suffix (e.g., `import { Item as Item$ } from "./common"`). All references to the imported type use the aliased name.
- [x] All 159/159 tests passing — DONE
- [x] Fix test 155_map_value_import_order: Map fields with message/enum value types now register the value type import at the map field's position (not as child of nested entry message). Map entry messages are also skipped during nested type scanning.
- [x] Fix test 156_no_package_import: When proto files have no `package` statement, imported types were not matched to dependency files. Added `depPkg == ""` condition in `generateImport` to include package-less files as candidates.
- [x] Fix test 157_no_package_enum_option: When proto files have no `package` statement, `resolveEnumValueName` and `findEnumInMessage` constructed `"..EnumName"` (double dot) instead of `".EnumName"`. Added `GetPackage() == ""` guard to skip the extra dot.
- [x] Fix test 158_no_package_client_import: When proto files have no `package` statement, `getImportPathForType`'s `typeInFile` helper rejected all no-package files because `strings.HasPrefix(typeName, ""+".") always returned false. Added `pkg != ""` guard and separate `parts` splitting for empty package, same pattern as test 156.
- [x] All 163/163 tests passing — DONE
- [x] Fix test 159_lowercase_nested_cross_pkg: Replaced uppercase-letter heuristic in stripPackage with actual file package lookup via findPackageForType — heuristic failed for message names starting with lowercase (e.g., `lowercaseParent.Nested` → `Nested` instead of `lowercaseParent_Nested`)
- [x] Fix test 160_deep_nested_import: Replaced hardcoded 1-2-3 level nesting checks in generateImport with recursive `findTypeInDescriptors` helper — handles arbitrary nesting depth (test had 4 levels: `Outer.Middle.Inner.Deep`)
- [x] All 165/165 tests passing — DONE
- [x] Fix test 161_field_multiline_trailing_comment: Multiline trailing comments (block comments) now output each line separately — first line as `// comment` after field declaration, subsequent lines as standalone `// comment` lines below. Fixed `getTrailingComments` to use `TrimRight("\n")` instead of `TrimSpace` to preserve trailing whitespace within lines.
- [x] All 166/166 tests passing — DONE
- [x] Fix test 162_oneof_multiline_trailing_comment: Applied same multiline trailing comment splitting to oneof member fields — first line appended to field declaration with `// `, subsequent lines as standalone `// ` lines below
- [x] All 167/167 tests passing — DONE
- [x] Fix test 163_service_import_collision: Added `precomputeImportAliases` that detects import name collisions in protobuf-ts registration order (input first, output second) separately from emission order (output above input). Added `formatTypeImport` helper for `{ Name as Alias }` syntax. Applied to both svc.ts and svc.client.ts.
- [x] Fix test 164_empty_message_wiretype_import: When first message is empty AND a service is present, WireType must be early — moved `firstMessageEmpty` check out of the `else` branch so it applies in both service and non-service cases
- [x] All 169/169 tests passing — DONE
- [x] Fix test 165_json_name_escape: Escaped backslashes and double quotes in field descriptor `jsonName` values using `strings.ReplaceAll` — comment annotations (JSDoc, binary read/write) intentionally leave json_name unescaped
- [x] All 170/170 tests passing — DONE
- [x] Fix test 166_enum_value_trailing_whitespace: Enum value trailing comments in JSDoc blocks need `TrimRight(" \t")` per line — block comments produce trailing spaces from ` */` that must be stripped in JSDoc output (but preserved in `//` line comment output per test 161)
- [x] All 171/171 tests passing — DONE
- [x] Fix test 167_deep_nested_enum_option: Made findEnumInMessage fully recursive via findEnumInMessageWithPrefix helper — previous code only went 2 levels deep (message→nested→enum) but test had 3 levels (Outer.Middle.Inner.DeepEnum)
- [x] Fix test 168_custom_option_string_tab: Added `\t` (tab) character escaping to custom option string values in both `formatCustomOptions` and `formatCustomOptionArray`, same pattern as `\n`/`\r` escaping
- [x] Fix test 169_syntax_detached_nospace: Syntax detached comments without leading space (e.g., `//NoSpace`) should NOT get a space added. Changed format from `"// %s"` (with space stripping) to `"//%s"` (preserving original leading space from SourceCodeInfo). Also fixed client file header to split original `detached` text instead of `TrimSpace`d version.
- [x] All 174/174 tests passing — DONE
- [x] Fix test 170_package_detached_nospace: Package-level detached comments without leading space need `//%s` format (same fix as syntax detached comments in test 169) — preserve original spacing instead of stripping and re-adding
- [x] All 175/175 tests passing — DONE
- [x] Fix test 171_reverse_field_order_import: Removed field number sorting in collectUsedTypes — protobuf-ts processes fields in declaration order (proto file order), not field number order. The sort+reverse was producing wrong order when fields were declared in non-ascending number order.
- [x] All 176/176 tests passing — DONE
- [x] Fix test 172_runtime_import_collision: When a proto message is named `WireType`, the runtime `WireType` import from `@protobuf-ts/runtime` collides. Added `wireTypeRef` field (`"WireType"` or `"WireType$"`) to generator, set in `collectLocalTypeNames` when local type named `WireType` exists. Updated `getWireType()` and all hardcoded `WireType.` references in map/packed write code to use `g.wireTypeRef`. Import line uses `wireTypeImportAlias()` to produce `{ WireType as WireType$ }`.
- [x] Fix test 173_message_type_collision: When a proto message is named `MessageType`, the runtime `MessageType` import from `@protobuf-ts/runtime` collides. Added `messageTypeRef` field (like `wireTypeRef`), set to `"MessageType$"` when local type named `MessageType` exists. Updated import line and class `extends` declaration to use `messageTypeRef`.
- [x] Fix test 174_service_type_collision: When a proto message is named `ServiceType`, the runtime-rpc `ServiceType` import from `@protobuf-ts/runtime-rpc` collides. Added `serviceTypeRef` field (like `wireTypeRef`/`messageTypeRef`), set to `"ServiceType$"` when local type named `ServiceType` exists. Updated import line and all `new ServiceType(` references to use `serviceTypeRef`.
- [x] All 179/179 tests passing — DONE
- [x] Fix test 175_unknown_field_handler_collision: When a proto message is named `UnknownFieldHandler`, the runtime import from `@protobuf-ts/runtime` collides. Added `unknownFieldHandlerRef` field (like `wireTypeRef`/`messageTypeRef`/`serviceTypeRef`), set to `"UnknownFieldHandler$"` when local type named `UnknownFieldHandler` exists. Updated import line and both usage sites (onRead, onWrite).
- [x] All 180/180 tests passing — DONE
- [x] Fix test 176_partial_message_collision: When a proto message is named `PartialMessage`, the runtime `PartialMessage` import from `@protobuf-ts/runtime` collides. Added `partialMessageRef` field (like `wireTypeRef`/`messageTypeRef`/`serviceTypeRef`/`unknownFieldHandlerRef`), set to `"PartialMessage$"` when local type named `PartialMessage` exists. Updated import line and `create()` method to use `partialMessageRef`.
- [x] All 181/181 tests passing — DONE
- [x] Fix test 177_binary_read_options_collision: When a proto message is named `BinaryReadOptions`, the runtime `BinaryReadOptions` import from `@protobuf-ts/runtime` collides. Added `binaryReadOptionsRef` field (like `wireTypeRef`/`messageTypeRef`/etc.), set to `"BinaryReadOptions$"` when local type named `BinaryReadOptions` exists. Updated import line and all usage sites (`internalBinaryRead` signature, `binaryReadMap` signature, `unpack` method).
- [x] All 182/182 tests passing — DONE
- [x] Fix test 178_binary_write_options_collision: When a proto message is named `BinaryWriteOptions`, the runtime `BinaryWriteOptions` import from `@protobuf-ts/runtime` collides. Added `binaryWriteOptionsRef` field (like `binaryReadOptionsRef`), set to `"BinaryWriteOptions$"` when local type named `BinaryWriteOptions` exists. Updated import line and `internalBinaryWrite` method signature to use `binaryWriteOptionsRef`.
- [x] All 183/183 tests passing — DONE
- [x] Fix test 179_ibinary_reader_collision: When a proto message is named `IBinaryReader`, the runtime `IBinaryReader` import from `@protobuf-ts/runtime` collides. Added `iBinaryReaderRef` field (like `binaryReadOptionsRef`/`binaryWriteOptionsRef`), set to `"IBinaryReader$"` when local type named `IBinaryReader` exists. Updated import line, `internalBinaryRead` method signature, and `binaryReadMap` method signature to use `iBinaryReaderRef`.
- [x] All 184/184 tests passing — DONE
- [x] Fix test 180_ibinary_writer_collision: When a proto message is named `IBinaryWriter`, the runtime `IBinaryWriter` import from `@protobuf-ts/runtime` collides. Added `iBinaryWriterRef` field (like `iBinaryReaderRef`), set to `"IBinaryWriter$"` when local type named `IBinaryWriter` exists. Updated import line, `internalBinaryWrite` method signature (writer param and return type) to use `iBinaryWriterRef`.
- [x] All 185/185 tests passing — DONE
- [x] Fix test 181_rpc_options_collision: When a proto message is named `RpcOptions`, it collides with the runtime-rpc `RpcOptions` import in the client file. Added client-specific collision detection after `precomputeImportAliases` that aliases the proto type import with `$` suffix (e.g., `RpcOptions as RpcOptions$`). All references to the proto type in method signatures use the aliased name.
- [x] Fix test 182_reflection_merge_collision: When a proto message is named `reflectionMergePartial`, the runtime import from `@protobuf-ts/runtime` collides. Added `reflectionMergePartialRef` field (like all other runtime import collision refs), set to `"reflectionMergePartial$"` when local type named `reflectionMergePartial` exists. Updated import line and `create()` method to use `reflectionMergePartialRef`.
- [x] Fix test 183_service_name_rpc_collision: When a service is named `RpcTransport`, it collides with the runtime-rpc `RpcTransport` type import. Added `rpcTransportRef` field, set to `"RpcTransport$"` when any service is named `RpcTransport`. Updated import line (aliased as `RpcTransport$`) and constructor parameter type to use `rpcTransportRef`.
- [x] Fix test 184_service_info_collision: When a service is named `ServiceInfo`, it collides with the runtime-rpc `ServiceInfo` type import. Added `serviceInfoRef` field (like `rpcTransportRef`), set to `"ServiceInfo$"` when any service is named `ServiceInfo`. Updated import line (aliased as `ServiceInfo$`) and `implements` clause to use `serviceInfoRef`.
- [x] All 189/189 tests passing — DONE
- [x] Fix test 185_service_name_unary_call_collision: When a service is named `UnaryCall` (or other call types), the proto service import is aliased with `$` suffix (e.g., `import { UnaryCall as UnaryCall$ } from "./test"`) so it doesn't collide with the runtime-rpc `UnaryCall` type. Added `serviceImportAliases` map, applied to both service import lines and `typeName`/`methods`/`options` references in `generateServiceClient`.
- [x] All 190/190 tests passing — DONE
- [x] Fix test 186_service_name_rpc_options_collision: When a service is named `RpcOptions`, it collides with the runtime-rpc `RpcOptions` type import in the client file. Added `"RpcOptions"` to `callTypeNames` so the proto service import is aliased with `$` suffix (same pattern as UnaryCall/ServerStreamingCall).
- [x] Fix test 187_service_name_stack_intercept: When a service is named `stackIntercept`, it collides with the runtime-rpc `stackIntercept` function import. Added `"stackIntercept"` to `callTypeNames` so the proto service import is aliased with `$` suffix (same pattern as UnaryCall/RpcOptions).
- [x] All 192/192 tests passing — DONE
- [x] Fix test 188_duplicate_local_name_create: Duplicate camelCase property dedup in create() must use last-write-wins (keep LAST occurrence), matching JS `Object.entries` behavior. Reversed iteration order in dedup loop, then re-reversed to restore original order.
- [x] All 193/193 tests passing — DONE
- [x] Fix test 189_client_syntax_two_blocks: Client file syntax detached comment blocks needed `hasTrailingNewline` handling and `blockIdx < len-1` separator (matching message file header), instead of unconditional `//` after every block
- [x] All 194/194 tests passing — DONE
- [x] Fix test 190_client_package_detached: Added package-level detached comments (path [2]) to client file header, same pattern as message file header — `//` prefix, `// ` for blank lines, empty separators between blocks
- [x] All 195/195 tests passing — DONE
- [x] Fix test 191_server_streaming_svc_name: Service call type collision check now only aliases when the call type is actually imported from runtime-rpc — computed `usedCallTypes` from actual method streaming patterns instead of checking against static `callTypeNames` set
- [x] All 196/196 tests passing — DONE
- [x] Fix test 192_false_client_alias: Proto message types named after runtime-rpc call types (e.g., `DuplexStreamingCall`) should only be aliased when that call type is actually imported from runtime-rpc. Moved `usedCallTypes` computation before `clientRuntimeNames` check and replaced static map with dynamic set. RpcTransport/ServiceInfo excluded from `usedCallTypes` since they're handled separately by `rpcTransportRef`/`serviceInfoRef`.
- [x] All 197/197 tests passing — DONE
- [x] Fix test 193_message_rpc_transport_collision: When a proto message (not service) is named `RpcTransport` or `ServiceInfo` and used in service methods, the runtime-rpc import must be aliased. Added method input/output type scan loop after the service name collision check.
- [x] All 198/198 tests passing — DONE
- [x] Fix test 194_message_stack_intercept: When a proto message (not service) is named `stackIntercept`, the runtime-rpc `stackIntercept` function import is aliased as `stackIntercept$` (not the proto type). Added `stackInterceptRef` field following RpcTransport/ServiceInfo pattern. Updated import line and all 4 `stackIntercept<...>` call sites.
- [x] All 199/199 tests passing — DONE
- [x] Fix test 195_underscore_digit_field: create() field init order must match JS Object.entries() enumeration — integer-like property keys (e.g., `123` from `_123`) come first in ascending numeric order, then string keys in insertion order. Added `isArrayIndex` helper and sort step after dedup.
- [x] All 200/200 tests passing — DONE
- [x] Fix test 196_comment_trailing_whitespace: Preserved trailing whitespace in detached comments (// style) by removing TrimRight from all 15 detached comment locations while keeping TrimRight in 3 JSDoc locations (test 166)
- [x] All 201/201 tests passing — DONE
- [x] Fix test 197_client_cross_file_type_collision: Added cross-file type collision detection in client file — when two proto types from different files/packages have the same TS name (e.g., `test.Result` and `dep.Result` both → `Result`), the later-registered type is aliased with `$` suffix. Uses protobuf-ts registration order (input first, output second per method) to determine which type claims the name.
- [x] All 202/202 tests passing — DONE
- [x] Fix test 198_whitespace_only_comment: Changed `getLeadingComments` to return `(string, bool)` — whitespace-only comments (e.g., `//   `) get trimmed to empty string but should still produce JSDoc output (` *` empty line). The `bool` distinguishes "no comment" from "whitespace-only comment trimmed to empty". Updated all 10 call sites.
- [x] All 203/203 tests passing — DONE
- [x] Fix test 199_keyword_nested_collision: Fixed collision detection between nested types and top-level types when parent has keyword-escaped name. `collectMessageTypeNames` used `tsName + "_"` (with `$` escape) as prefix for nested types, while `generateMessageInterface` used `parentPrefix + baseName + "_"` (unescaped). Changed to use `parentPrefix + baseName + "_"` to match. Also fixed `collectLocalTypeNames` to track proto names separately instead of using `ReplaceAll(name, "_", ".")` which is ambiguous.
- [x] All 204/204 tests passing — DONE

## Notes

- Run tests with `protoc-gen-kaja/scripts/test --summary`. Full output without `--summary`.
- Use `protoc-gen-kaja/scripts/diff <test_name>` to inspect specific failures.
- Results are in `protoc-gen-kaja/results/<test_name>/`. Each has `expected/`, `actual/`, `result.txt`, and optionally `failure.txt`.
- The WKT generation logic (main.go ~line 209) must check `len(generatedFiles) > 0` before generating WKTs, but check ALL FileToGenerate (not just those with output) for dependency relationships. This handles both: (a) import-only files producing no output (test 79), and (b) transitive WKT deps through non-output files like `options.proto` (test 61).
- The `getMapValueWriter` function was simplified to reuse `getWireType` and `getWriterMethodName` instead of an incomplete switch statement. The old version only handled 4 types (int32, string, bool, enum) and fell back to string for everything else.
- The `getMapKeyWriter` function had the same problem — it grouped fixed types with their non-fixed counterparts (e.g. SFIXED32 with INT32), using WireType.Varint instead of WireType.Bit32. Simplified it the same way to delegate to getWireType+getWriterMethodName.
- The message-value map write path (line ~3456) had its own hardcoded key writer (Varint/int32 for all numeric keys) instead of reusing `getMapKeyWriter`. Fixed to use the same keyVar/valueAccessor logic as the scalar path, plus `getMapKeyWriter` for proper wire types.
- Proto2 `required` message fields must still generate optional TS interface properties (`?:`) because messages have no zero value. The fix adds a check: when `LABEL_REQUIRED` and `TYPE_MESSAGE`, set `optional = "?"`.
- Proto2 oneof member fields have `LABEL_OPTIONAL` but should NOT show `optional` in generated comments. The fix checks `field.OneofIndex == nil` before adding the `optional` prefix in `getProtoType`.
- Oneof scalar fields with custom `json_name` need it in two places: (1) the interface field comment `[json_name = "..."]` and (2) the field info entry `jsonName: "..."` inserted between `localName` and `oneof` properties. The `internalBinaryRead`/`Write` comment paths already handled it.
- Deprecated oneof member fields need `@deprecated` JSDoc tag and `[deprecated = true]` in the `@generated` comment, same pattern as regular fields. The oneof interface generation (around line 2229) was missing this; added `fieldIsDeprecated` check and `oneofDeprecatedAnnotation` string.
- For nested messages, `generateOneofField` must receive the actual message descriptor and full `msgPath` (e.g. `[4, 0, 3, 0]`), not just the last element of `msgPath`. Using `g.file.MessageType[msgIndex]` only works for top-level messages. The field path must be built as `msgPath + [2, fieldIndex]` and the oneof path as `msgPath + [8, oneofIndex]`.
- The map binary read error string (`"unknown map entry field for ..."`) was using `strings.ReplaceAll(fullName, "_", ".")` to convert the TS name back to proto name. This breaks when message names themselves contain underscores (e.g., `My_Container`). Fixed to use `protoName` parameter directly, which already has the correct dot-separated nesting.
- Oneof member fields with default values need `[default = ...]` in their `@generated from protobuf field:` interface comments. The oneof comment generation was missing the `defaultAnnotation` that regular field comments already had. Added `oneofDefaultAnnotation` using the same `formatDefaultValueAnnotation` helper.
- The `__HAS_TRAILING_BLANK__` marker must be handled in ALL comment generation paths. Oneof comments (~line 2177) and oneof field comments (~line 2222) were missing this handling, causing the marker to appear literally in output. The pattern is: strip the marker, then emit two `*` lines instead of one before the `@generated` tag.
- Enum trailing comments (TrailingComments on the enum path, e.g. `[5,0]`) need to be included in the enum's JSDoc comment. Added `getEnumTrailingComments` method that preserves trailing blank info (unlike regular `getTrailingComments` which strips it). Enum value leading comments also need `__HAS_TRAILING_BLANK__` handling.
- Service and method comments in `generateServiceClient` (client file) had 4 locations that unconditionally output one ` *` after comment lines but need two when `hasTrailingBlank` is true. Same pattern as everywhere else.
- Oneof declarations need detached comment handling (LeadingDetachedComments on the oneof path `[4, msgIdx, 8, oneofIdx]`). These are output as `// ...` lines before the oneof's JSDoc `/**` block, same pattern as field detached comments.
- The first oneof member field's "detached comment" is actually a **trailing comment** on the oneof declaration itself (path `[4, msgIdx, 8, oneofIdx]`), not a LeadingDetachedComment on the field. It goes into the oneof JSDoc block before `@generated from protobuf oneof:`. Non-first member field detached comments are proper LeadingDetachedComments on the field path and go as `//` style before the field's JSDoc.
- Service method detached comments should be output for ALL methods including the first one (methodIdx == 0). The `methodIdx > 0` guard was wrong — it skipped the first method's detached comments in both the interface and implementation sections of `generateServiceClient`.
- Field names whose camelCase form equals `oneofKind` must be escaped with `$` suffix (e.g. `oneofKind$`). This is because `oneofKind` is the discriminator property used by protobuf-ts for oneof unions. The TS plugin checks against `oneofKindDiscriminator` option (default `"oneofKind"`). The escaping must also trigger `localName` in the field info descriptor.
- Service-level detached comments (LeadingDetachedComments on path `[6, svcIndex]`) must be output as `//` line comments before the `/**` JSDoc block for both the interface and the class in `generateServiceClient`. Same pattern as oneof detached comments but using `g.pNoIndent()` since service comments are at top level (no indent).
- Oneof names whose camelCase form equals `oneofKind` must also be escaped with `$` suffix. There are 5 separate locations where `oneofCamelName` is computed and needs the escape check: interface generation (~line 1943), field descriptor generation (~line 2885), create() method (~line 3225), internalBinaryRead (~line 3346), and internalBinaryWrite (~line 3569). All must check `__proto__`, `toString`, AND `oneofKind`.
- Service method detached comments with multiple blocks need empty line separators between blocks (`if idx < len(detachedComments)-1 { g.pNoIndent("") }`), plus blank-line-within-block handling (`// ` with trailing space) and a final blank line after all blocks before the JSDoc. Same pattern as field detached comments. Both the interface and implementation sections of `generateServiceClient` need this fix.
- File-level detached comments on the first message (path `[4, 0]`) use `// ` (trailing space) for blank lines and empty lines between blocks. IMPORTANT: the file-header license comment section (syntax path `[12]`) uses `//` (no trailing space) — these are two different code paths and must NOT be confused.
- Enum declarations need detached comment handling (LeadingDetachedComments on enum path e.g. `[5, enumIdx]`). Same pattern as message/field detached comments: `//` style before JSDoc, `// ` (trailing space) for blank lines within blocks, empty lines between blocks, blank line after all blocks before JSDoc.
- Field options in comments must be combined into a single `[opt1, opt2, ...]` bracket, not separate `[opt1] [opt2]` brackets. Order matches protobuf-ts: packed, default, json_name, jstype, deprecated. Use `formatFieldOptionsAnnotation` helper.
- WireType import ordering depends on whether the first message's InternalBinaryRead registers WireType (for repeated numeric/enum fields). If yes, WireType goes after UnknownFieldHandler ("very late"). The check is: first message has at least one repeated scalar/enum field that is not string/bytes/message. This is syntax-agnostic (applies to both proto2 and proto3).
- File-level `option deprecated = true` must propagate `@deprecated` to oneof JSDoc comments. The oneof comment generation (around line 2269) was missing the `g.isFileDeprecated()` check before `@generated from protobuf oneof:`. Added it between the trailing comment and the `@generated` tag.
- Message interface JSDoc needs trailing comments (TrailingComments on message path e.g. `[4, msgIdx]`) inserted between leading comments and `@generated` tag. Reuse `getEnumTrailingComments` (which preserves trailing blank info via `__HAS_TRAILING_BLANK__` marker) since `getTrailingComments` strips that info.
- Service and method trailing comments in client file (`generateServiceClient`) need to be included in all 4 JSDoc locations: service interface, service class, method interface, method class. Uses same `getEnumTrailingComments` pattern with `__HAS_TRAILING_BLANK__` handling. Service uses `g.pNoIndent`, methods use `g.p`.
- Client file import ordering for UnaryCall depends on whether method 0 of the first service is streaming. In protobuf-ts, imports are prepended (each new import goes to top), so the last-registered import appears first. When method 0 is streaming, UnaryCall (from a later unary method) gets prepended after all of method 0's imports, placing it ABOVE stackIntercept. When method 0 is unary, UnaryCall is registered early (during method 0) and ends up below stackIntercept. The Go code emits in forward order, so it must check `method0IsStreaming` to decide where UnaryCall goes.
- String/bytes default value annotation: protobuf-ts uses JavaScript `String.replace('"', '\\"')` which only replaces the FIRST double-quote occurrence. Our Go code must use `strings.Replace(val, `"`, `\"`, 1)` (count=1) to match this behavior. Do NOT escape all quotes.
- `jstype = JS_NORMAL` on 64-bit integer fields (int64, uint64, sint64, fixed64, sfixed64) overrides the `long_type_string` parameter. Effects: TS type becomes `bigint`, default value is `0n`, reader uses `.toBigInt()`, field descriptor gets `L: 0 /*LongType.BIGINT*/`, and annotation shows `[jstype = JS_NORMAL]`. Helper functions `isJsTypeNormal()` and `is64BitIntType()` were added. All 10 reader method locations (5 types × 2 functions: `getReaderMethod` + `getReaderMethodSimple`) need the JS_NORMAL check alongside the existing JS_NUMBER check.
- `optimize_for = LITE_RUNTIME` behaves identically to `CODE_SIZE` — both skip `create()`, `internalBinaryRead()`, `internalBinaryWrite()` methods and their Phase 2 imports. The `isOptimizeCodeSize()` helper checks for both `CODE_SIZE` and `LITE_RUNTIME`.
- String default values with `\r` (CR, 0x0d) characters: the `\r`→`\n` conversion is now handled in `g.p()` instead of `formatDefaultValueAnnotation`. This allows `g.p()` to distinguish `\r` (raw line break, no JSDoc prefix) from `\n` (JSDoc continuation with ` * ` prefix). The `g.p()` function processes characters individually: `\n` in a JSDoc line (starting with ` * `) adds ` * ` prefix to the continuation line; `\r` just adds the indent.
- Streaming-only services: When all methods in a service are streaming, the call type import (e.g., `ServerStreamingCall`) was emitted twice — once in the streaming methods section (section 3) and once in the method 0 section (section 5). Fix: compute `method0CallType` and skip it from section 3's emission since section 5 already handles it. This dedup applies to both the interleave and grouped code paths.
- Mixed streaming/unary services: When method 0 is streaming and later methods are unary, UnaryCall must appear ABOVE the other streaming call types (DuplexStreamingCall, ClientStreamingCall) because in protobuf-ts's prepend model, later-processed methods' imports go to the top. The UnaryCall emission was moved from after section 3 to before section 3's call type emissions, guarded by `method0CallType != "" && hasUnaryInService`.
- Custom message options: Messages with custom options (via `extend google.protobuf.MessageOptions`) need those options passed as a third argument to the MessageType constructor's `super()` call, e.g. `super("test.User", [...], { "test.resource_name": "users", "test.cacheable": true })`. The option extraction logic (`buildExtensionMap` + `parseCustomOptions`) is shared between method and message options. Extension fields are found in `file.Extension` of all files, matched by `extendee` name. Values are read from unknown fields in the options message's wire format.
- Enum alias deprecated: When `allow_alias = true` and an alias has `[deprecated = true]` but the original value does not, the generated alias entry should use the **original value's** deprecated status (not the alias's). Protobuf-ts treats aliases as duplicates of the original — they get the original's comments, name in `@generated`, and deprecation status.
- Custom field options: Fields with custom options (via `extend google.protobuf.FieldOptions`) need `options: { ... }` in their field descriptor entries. Added `getCustomFieldOptions` following the same pattern as `getCustomMethodOptions`/`getCustomMessageOptions` (builds extension map for `.google.protobuf.FieldOptions`, parses unknown fields). The `options` property is appended after `longTypeParam` in all 3 field descriptor output branches (regular scalar, oneof scalar, message/enum/map).
- Custom service options: Services with custom options (via `extend google.protobuf.ServiceOptions`) need those options passed as a third argument to the ServiceType constructor, e.g. `new ServiceType("test.SearchService", [...], { "test.api_version": "v2", "test.internal": true })`. Added `getCustomServiceOptions` following the same pattern as `getCustomMessageOptions` (builds extension map for `.google.protobuf.ServiceOptions`, parses unknown fields).
- Service-only file import ordering: simple array reversal breaks per-method pair ordering (output above input). Must collect types as per-method pairs, reverse the pairs (so later methods appear first), then flatten. Files with messages don't reverse at all — they keep the forward collection order (output, input per method).
- Custom option key quoting: protobuf-ts only quotes custom option keys that contain dots (package-qualified names like `"test.resource_name": "users"`). Simple names without dots are unquoted (`column_name: "q"`). The `formatCustomOptions` function was unconditionally quoting all keys with `fmt.Sprintf("\"%s\": ...")`. Fixed by checking `strings.Contains(opt.key, ".")` before deciding whether to quote.
- Custom enum-typed options: When a custom option field has `TYPE_ENUM`, the varint wire value must be resolved to the enum value's name string (e.g., `2` → `"VISIBILITY_INTERNAL"`). Added `resolveEnumValueName` helper that searches all files' top-level and nested enums by fully-qualified type name. The string name is stored as the option value, so `formatCustomOptions` outputs it as a quoted string.
- Custom sint/sfixed/fixed options: TYPE_SINT32/SINT64 use zigzag encoding — decode with `protowire.DecodeZigZag(v)`. TYPE_SFIXED32/SFIXED64 use Fixed32/Fixed64 wire format with signed interpretation (cast through int32/int64). TYPE_FIXED32/FIXED64 use Fixed32/Fixed64 wire format with unsigned interpretation. All store as `int` value in customOption.
- Custom message-typed options: When a custom option field has `TYPE_MESSAGE`, the LengthDelimited wire value must be recursively decoded into an ordered list of field name→value pairs. Added `parseMessageValue` helper that builds a `fieldNumber → FieldDescriptorProto` map from the message descriptor, then decodes each field using the same type-switching logic as `parseCustomOptions`. Returns `[]customOption` which is handled by `formatCustomOptions` via a new `[]customOption` type case that recursively calls `formatCustomOptions`. Message field names (unlike extension names) are simple names without dots, so they are always unquoted in the output.
- Repeated custom options: When an extension field has `repeated` label, multiple wire values with the same field number must be merged into a single array value (e.g., `{ "test.tags": ["alpha", "beta"] }` not `{ "test.tags": "alpha", "test.tags": "beta" }`). Added `mergeRepeatedOptions` post-processing step in `parseCustomOptions` and `formatCustomOptionArray` helper for `[]interface{}` type in formatting.
- Custom bytes options: TYPE_BYTES fields in custom options must be base64-encoded using `base64.StdEncoding.EncodeToString`. The bytes value is read via `protowire.ConsumeBytes` and stored as a string (which formatCustomOptions wraps in quotes). Both `parseCustomOptions` and `parseMessageValue` need the TYPE_BYTES case.
- Custom 64-bit integer options: Per protobuf JSON mapping spec, 64-bit integer types (int64, uint64, sint64, fixed64, sfixed64) must be output as quoted strings (e.g., `"1000"` not `1000`). 32-bit types (int32, uint32, sint32, fixed32, sfixed32) remain as numeric values. This applies in both `parseCustomOptions` (extension fields) and `parseMessageValue` (message fields). TYPE_INT64 uses `int64(v)` cast for correct negative value handling; TYPE_UINT64 uses raw `v`.
- Nested repeated options: `parseMessageValue` must call `mergeRepeatedOptions` on its result before returning, same as `parseCustomOptions` does. Without this, repeated fields inside nested message-typed options produce duplicate keys (e.g., `tags: "a", tags: "b"`) instead of arrays (`tags: ["a", "b"]`).
- Custom option string escaping: String values in custom options may contain double quotes, backslashes, newlines, and carriage returns. Escape order: backslashes first (`\` → `\\`), then double quotes (`"` → `\"`), then newlines (`\n` → `\n` literal), then carriage returns (`\r` → `\r` literal). Both `formatCustomOptions` and `formatCustomOptionArray` need all four escaping steps. Order matters: escape backslashes before everything else to avoid double-escaping.
- Custom message option JSON names: Message-typed custom option field values use `GetJsonName()` (camelCase) not `GetName()` (snake_case). Protobuf-ts serializes message option values via `toJson()`, which uses lowerCamelCase. In `parseMessageValue`, line 605, use `fd.GetJsonName()` instead of `fd.GetName()`.
- Nested extensions: `buildExtensionMap` must scan `msg.Extension` recursively (not just `file.Extension`) to find extensions defined inside messages (e.g., `message Extensions { extend google.protobuf.FieldOptions { ... } }`). The `extInfo.msgPrefix` field stores parent message names so the extension key becomes `<package>.<MessageName>.<field_name>` (e.g., `test.Extensions.searchable`).
- Custom float NaN/Infinity: NaN, +Inf, -Inf float/double values must be stored as string type (not float64) in customOption so they're automatically quoted in output. Protobuf-ts's `toJson()` serializes these as `"NaN"`, `"Infinity"`, `"-Infinity"` (quoted strings). Both `parseCustomOptions` and `parseMessageValue` float/double branches need `math.IsNaN`/`math.IsInf` checks before storing.
- Custom float scientific notation: JavaScript's `Number.prototype.toString()` uses scientific notation for |v| < 1e-6 or |v| >= 1e21, fixed-point otherwise. Go's `strconv.FormatFloat(v, 'f', -1, 64)` always uses fixed-point. Added `formatFloatJS` helper that uses Go's `'e'` format for the scientific range (with exponent leading-zero stripping to match JS) and `'f'` format otherwise.
- Custom map options: Map fields (`map<K, V>`) in custom message-typed options must be serialized as plain objects (`{ key1: value1, key2: value2 }`) not as arrays of entry messages (`[{ key: ..., value: ... }]`). Protobuf-ts's `toJson()` converts map entries to object format. In `parseMessageValue`, detect `GetMapEntry()` on the nested message, extract key/value from entry, and store as `mapEntryValue` struct. `mergeRepeatedOptions` then merges multiple `mapEntryValue` instances for the same field into a `[]customOption` (object).
- Custom map integer keys: Integer map keys (int32, int64, uint32, uint64, sint32, sint64, fixed32, fixed64, sfixed32, sfixed64) must be quoted strings in the output (`"1": "one"` not `1: "one"`), per protobuf JSON mapping spec. Boolean keys remain unquoted. In `parseMessageValue`'s map entry handling, detect numeric key type and wrap the key string in `"..."` before storing in `mapEntryValue`.
- Custom map digit-leading string keys: String map keys starting with a digit (e.g., `123abc`) must be quoted in JS object literals since they aren't valid JS identifiers. In `formatCustomOptions`, the key quoting check was extended to also trigger when `opt.key[0]` is a digit (`'0'`-`'9'`), not just when the key contains a dot.
- Packed repeated scalars in custom options: In proto3, repeated scalar fields use packed encoding by default. The wire type is `BytesType` (LengthDelimited) containing multiple concatenated values. `parseMessageValue` must check `typ == BytesType && label == REPEATED` and, for scalar types, read the packed bytes first, then decode each value from the inner byte slice. Covers varint types (int32, uint32, int64, uint64, sint32, sint64, bool, enum), fixed32 types (fixed32, sfixed32, float), and fixed64 types (fixed64, sfixed64, double).
- Empty services: Services with zero methods need special handling: (1) skip `RpcOptions` import (guarded by `hasAnyMethod`), (2) output `new ServiceType("...", []);` on one line instead of `[\n]);` (early return before the method-descriptor loop).
- Enum prefix detection: protobuf-ts's `findEnumSharedPrefix` unconditionally appends `_` after UPPER_SNAKE_CASE conversion. The Go code was conditionally adding `_` only when the prefix didn't already end with `_`, which broke for enum names ending with `_` (e.g., `MyEnum_` should produce prefix `MY_ENUM__` not `MY_ENUM_`).
- Duplicate streaming call type imports: When multiple non-method-0 streaming methods share the same call type (e.g., two server-streaming methods), only one import should be emitted. In the interleave path, use `lastCallTypeIdx` map to emit each call type only at its last occurrence in `streamingMethods` (which corresponds to the first registration in protobuf-ts's prepend model, since streamingMethods is collected in reverse order).
- Client import ordering for mixed streaming/non-streaming: When a type is used by both streaming and non-streaming methods, the type import must appear at the position of the FIRST method (forward order) that uses it. A forward-pass `firstMethodForType` map determines this. Without it, the N→1 collection would place the type at the first streaming method that encounters it (which may be at a higher index), causing it to appear above streaming call types when it should be below. The unified `imports` list (replacing separate `streamingMethods` and `nonStreamingTypes`) maintains correct relative ordering.
- Proto3 optional detection: NEVER use heuristics (oneof name starts with `_`, single field, name match) to detect proto3 optional fields. Always use `field.Proto3Optional != nil && *field.Proto3Optional`. The heuristic fails for real oneofs whose name starts with `_` (e.g., `oneof _value { string value = 2; }`) — such a oneof matches all heuristic conditions but `Proto3Optional` is false. There are 5 locations in the code that need this check: interface generation (~line 2545), field descriptor generation (~line 3679), create() method (~line 3788), internalBinaryRead (~line 3889), and internalBinaryWrite (~line 4069).
- Duplicate camelCase property names in create(): When two proto fields resolve to the same camelCase TS property name (e.g., `x123y` and `x_123_y` both → `x123Y`), the `create()` method must only initialize the property once. After collecting `initItems`, deduplicate by `fieldName` keeping only the first occurrence. Oneofs are exempt from dedup (they use `oneofName` instead).
- Package detached comments: Comments between `syntax` and `package` declarations appear as LeadingDetachedComments on the package statement (path `[2]`). These are output after the file header (after syntax path `[12]` detached comments) using the same pattern: `//` blank line prefix, comment lines, `//` trailing newline. Only needed in the message file header (around line 1367), not the client file header.
- Import name collisions: When an imported type has the same TS name as a locally defined type (e.g., both files define `Item`), the import must be aliased with `$` suffix: `import { Item as Item$ } from "./common"`. All references to the imported type use the aliased name. Implementation: `collectLocalTypeNames()` gathers all local message/enum TS names (including nested with `_` joining), `generateImport` checks for collision with `localTypeNames`, and `stripPackage` checks `importAliases` map before normal resolution. Important: the collision check must only compare against `localTypeNames`, not `importedTypeNames` — otherwise types imported in Phase 1 (service-only) would falsely collide with themselves in Phase 3 (message-field). An early-return check in `generateImport` handles already-imported types.
- Map value import ordering: For map fields with message/enum value types, the value type import must be registered at the position of the map field itself (in `collectUsedTypes`), NOT as a child of the nested map entry message. The entry message type is local and doesn't generate an import, but scanning it as a nested type would add the value type at the wrong position (after all parent message fields). Fix: in `scanMessage`, detect map entry types (via `findMessageType` + `GetMapEntry()`), extract the value field's type directly, and skip map entry messages from nested type recursion.
- No-package client import resolution: `getImportPathForType`'s `typeInFile` helper had the same bug as `generateImport` (test 156) — when `pkg == ""`, it checked `strings.HasPrefix(typeName, ".")` which always failed for stripped type names. Fix: add `pkg != ""` guard before the prefix check, and split `typeName` directly (not with `pkg+"."` prefix) when package is empty.
- Multiline trailing comments: Block comments (`/* ... */`) produce multiline trailing comments in SourceCodeInfo. These must be output as separate lines: first line appended to the field declaration with `// `, subsequent lines as standalone `// ` comments below. The `getTrailingComments` function must use `TrimRight("\n")` (not `TrimSpace`) to preserve trailing whitespace within lines — protobuf-ts preserves these spaces.
- Empty first message WireType ordering: When the first message has no fields (empty message), WireType import must be early (before BinaryWriteOptions) regardless of whether a service is present. The `firstMessageEmpty` check was previously inside the `else` branch (no service only). Moved it out so it applies in both `needsServiceType` and non-service cases. This is because in protobuf-ts's prepend model, the second message's WireType registration gets prepended above the empty first message's imports.
- jsonName escaping: Only the field descriptor `jsonName: "..."` value needs `\`→`\\` and `"`→`\"` escaping. Comment annotations (`[json_name = "..."]` in JSDoc, internalBinaryRead/Write) are plain text inside `/* */` comments and must NOT be escaped — protobuf-ts outputs them raw.
- Deep nested enum resolution: `findEnumInMessage` must recurse to arbitrary depth, not just 2 levels. Extracted `findEnumInMessageWithPrefix(prefix, msg, typeName, number)` that recurses through `msg.NestedType` with accumulated prefix. The old code only checked `msg.EnumType` and `msg.NestedType[].EnumType` (2 levels), missing enums at depth 3+ (e.g., `Outer.Middle.Inner.DeepEnum`).
- Custom option tab escaping: Tab characters (`\t`, 0x09) in custom option string values must be escaped as `\t` in generated JS string literals, same as `\n` and `\r`. Both `formatCustomOptions` and `formatCustomOptionArray` need the escaping step after `\r` escaping.
- Field import order: protobuf-ts processes fields in **declaration order** (proto file order), not field number order. The `collectUsedTypes` function must iterate `msg.Field` in original slice order, then reverse the collected list to match prepend behavior. Sorting by field number breaks when fields are declared in non-ascending number order (e.g., field 2 before field 1).
- Syntax detached comment spacing: SourceCodeInfo stores comments without `//` prefix. A comment `// text` is stored as ` text` (with leading space); `//text` is stored as `text` (no space). Use `//%s` format to preserve the original spacing — do NOT strip leading space and re-add it. The client file header was also using `TrimSpace` on the full comment text before splitting, which stripped leading spaces from all lines — must split original text instead.
- Runtime WireType import collision: When a proto message is named `WireType`, it collides with the `WireType` import from `@protobuf-ts/runtime`. The `wireTypeRef` field on `generator` is set to `"WireType$"` when `localTypeNames` contains `"WireType"`. The import line becomes `import { WireType as WireType$ }`. All `getWireType()` returns and hardcoded `WireType.LengthDelimited`/`WireType.Varint` in map/packed write code use `g.wireTypeRef` prefix. The `wireTypeImportAlias()` helper returns `" as WireType$"` or `""` for the import statement.
- Runtime ServiceType import collision: Same pattern as WireType/MessageType — when a proto message is named `ServiceType`, the `ServiceType` import from `@protobuf-ts/runtime-rpc` is aliased as `ServiceType$`. Uses `serviceTypeRef` field, checked in `collectLocalTypeNames`. Three locations need the ref: the import line (~line 1907), and the three `new ServiceType(` call sites (empty service with/without custom opts, and non-empty service opener).
- Runtime UnknownFieldHandler import collision: Same pattern as WireType/MessageType/ServiceType — when a proto message is named `UnknownFieldHandler`, the runtime import is aliased as `UnknownFieldHandler$`. Uses `unknownFieldHandlerRef` field. Two usage sites: `onRead` in internalBinaryRead and `onWrite` in internalBinaryWrite. Import uses `unknownFieldHandlerImport()` helper.
- Runtime PartialMessage import collision: Same pattern as all other runtime import collisions — when a proto message is named `PartialMessage`, the runtime import is aliased as `PartialMessage$`. Uses `partialMessageRef` field. Two usage sites: import line and `create()` method parameter type. Import uses `partialMessageImport()` helper.
- Runtime BinaryReadOptions import collision: Same pattern as all other runtime import collisions — when a proto message is named `BinaryReadOptions`, the runtime import is aliased as `BinaryReadOptions$`. Uses `binaryReadOptionsRef` field. Three usage sites: import line, `internalBinaryRead` method signature (`options: BinaryReadOptions$`), `binaryReadMap` private method signature, and `unpack` method for Any types. Import uses `binaryReadOptionsImport()` helper.
- Runtime BinaryWriteOptions import collision: Same pattern as BinaryReadOptions — when a proto message is named `BinaryWriteOptions`, the runtime import is aliased as `BinaryWriteOptions$`. Uses `binaryWriteOptionsRef` field. Two usage sites: import line and `internalBinaryWrite` method signature. Import uses `binaryWriteOptionsImport()` helper.
- Runtime IBinaryReader import collision: Same pattern as BinaryWriteOptions — when a proto message is named `IBinaryReader`, the runtime import is aliased as `IBinaryReader$`. Uses `iBinaryReaderRef` field. Three usage sites: import line, `internalBinaryRead` method signature (`reader: IBinaryReader$`), and `binaryReadMap` private method signature. Import uses `iBinaryReaderImport()` helper.
- Runtime IBinaryWriter import collision: Same pattern as IBinaryReader — when a proto message is named `IBinaryWriter`, the runtime import is aliased as `IBinaryWriter$`. Uses `iBinaryWriterRef` field. Two usage sites: import line and `internalBinaryWrite` method signature (writer param and return type). Import uses `iBinaryWriterImport()` helper.
- Runtime ServiceInfo service name collision: Same pattern as RpcTransport — when a service is named `ServiceInfo`, the `ServiceInfo` import from `@protobuf-ts/runtime-rpc` is aliased as `ServiceInfo$`. Uses `serviceInfoRef` field. Two locations: import line and `implements` clause on the client class.
- Service call type name collision: When a service is named after a call type (UnaryCall, ServerStreamingCall, ClientStreamingCall, DuplexStreamingCall), the proto service import is aliased with `$` suffix (not the runtime import). This differs from RpcTransport/ServiceInfo collisions where the runtime import is aliased. Uses `serviceImportAliases` map on generator, populated in `generateClientFile`, applied in service import lines and `generateServiceClient` via `serviceRef` variable. IMPORTANT: only alias when the call type is actually imported from runtime-rpc — if a service is named `ServerStreamingCall` but has no server-streaming methods, there's no collision and no alias is needed. Use `usedCallTypes` set computed from actual method streaming patterns.
- Message RpcTransport/ServiceInfo collision: When a **message** (not service) is named `RpcTransport` or `ServiceInfo` and is used as a method input/output type, the runtime-rpc import must be aliased with `$` suffix. This is different from service-name collision (which was already handled). Added a second scan loop over method input/output types after the service name scan. The `rpcTransportRef`/`serviceInfoRef` mechanism works the same way — it aliases the runtime import and uses the aliased name in the constructor parameter.
- Message stackIntercept collision: When a **message** (not service) is named `stackIntercept` and is used as a method input/output type, the runtime-rpc `stackIntercept` function import must be aliased as `stackIntercept$`. This follows the same pattern as `RpcTransport`/`ServiceInfo` message collisions — the runtime import is aliased, NOT the proto type. Added `stackInterceptRef` field. The proto type `stackIntercept` remains unaliased in method signatures. The aliased `stackIntercept$` is used in function calls. Important: `stackIntercept` must be excluded from the `usedCallTypes` proto-import aliasing check (which would incorrectly alias the proto import instead of the runtime import).
- Client cross-file type collision: In the client file, ALL types (local AND external) are imported, so types from different packages with the same TS name collide. Unlike the message file (where `localTypeNames` gives local types priority), the client file uses pure registration order — first type to claim a name wins, later types get `$` suffix. The collision detection runs after `precomputeImportAliases` (which handles external-external and external-local collisions for the message file) and before runtime-rpc name collision checks. Uses `g.stripPackage()` for TS name computation (which returns raw names since `importAliases` is still empty at that point). Once aliases are set, `g.stripPackage()` returns the aliased name, so `seen` map dedup in the import emission code naturally handles both names as distinct entries.
- Whitespace-only comments: Comments like `//   ` (only whitespace after `//`) get stored as `"   \n"` in SourceCodeInfo and produce `""` after trimming. `getLeadingComments` now returns `(string, bool)` — the bool is `true` when LeadingComments was non-nil, allowing call sites to distinguish "no comment" from "whitespace-only comment trimmed to empty". When `hasLeading=true` and `leadingComments=""`, `strings.Split("", "\n")` → `[""]` → one empty JSDoc line ` *` is rendered, followed by the standard separator ` *` before `@generated`.
- Keyword-nested collision: When a parent message has a TS keyword name (e.g., `object` → `object$`), nested type TS name prefix must use the UNESCAPED name (`object_`) not the escaped name (`object$_`). The `collectMessageTypeNames` collision detector was using `tsName + "_"` (includes `$`), while `generateMessageInterface` uses `parentPrefix + baseName + "_"` (no `$`). This caused collision detection to see `object$_Bar` and `object_Bar` as distinct names, missing the collision. Also, `collectLocalTypeNames` was using `strings.ReplaceAll(name, "_", ".")` to reconstruct proto names, which is ambiguous when names contain underscores — refactored to track proto names separately.
