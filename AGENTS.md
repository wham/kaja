- See [Development](README.md#development) for instructions how to run and test.
- To re-generate Protobuf files, run `scripts/server`. No custom commands.
- Only add code comments for really tricky parts; otherwise keep it clean.
- If API is called "getConfiguration", use "configuration" not "config" in code.
- Don't run `go build` directly; use `scripts/server` and/or `scripts/desktop`.
- The is using https://primer.style/product/getting-started/react/. Use out-of-the-box Primer components as much as possible. Avoid custom styling unless absolutely necessary.
- Don't update generated files directly; they will be overwritten.
  - `ui/src/wailsjs/**` are generated by Wails.

## Directory Structure

### Root Directories

- **`ui/`** - React/TypeScript frontend code using Primer React components
- **`server/`** - Go server for Docker/production deployment
- **`desktop/`** - Wails desktop application wrapper
- **`workspace/`** - Demo applications (gRPC and Twirp servers for testing)
- **`scripts/`** - Build and development scripts
- **`docs/`** - Documentation assets (logo, screenshots)

### Build and Work Directories

The project has multiple build directories for different purposes:

#### `/build` (Root Level, Git Ignored)
**Purpose:** Shared build artifacts used by both server and desktop builds
**Created by:** `scripts/server` and `scripts/desktop`
**Contents:**
- `protoc-gen-ts` - Bundled TypeScript protobuf plugin (executable)
- Protobuf code generation tools (`protoc-gen-go`, `protoc-gen-twirp`, `protoc-gen-go-grpc`)

**Why it exists:** These tools are needed at runtime by the server to compile user's `.proto` files. The `protoc-gen-ts` is bundled from `ui/node_modules` using esbuild to make it standalone and portable.

#### `/server/build` (Git Ignored)
**Purpose:** Server production UI artifacts
**Created by:** `go run server/cmd/build-ui/main.go`
**Contents:**
- `main.js` - Bundled and minified React application (esbuild output)
- `main.css` - Bundled and minified CSS
- `codicon-37A3DWZT.ttf` - Monaco editor font
- `monaco.*.worker.js` - Monaco editor web workers (json, css, html, ts, editor)

**Why it exists:** The server embeds these files using `//go:embed` directives in `server/assets_production.go` for Docker/production deployment. No separate web server needed.

#### `/desktop/build/bin` (Git Ignored)
**Purpose:** Wails desktop application compiled binaries
**Created by:** `wails build` (invoked by `wails dev`)
**Contents:** Platform-specific desktop executables

**Why it exists:** Wails build output directory for desktop app distribution.

#### `/desktop/build/sources/{project}` (Git Ignored)
**Purpose:** Runtime-generated TypeScript sources from user's `.proto` files
**Created by:** Runtime protoc compilation in `server/pkg/api/compiler.go`
**Contents:** Generated TypeScript RPC client code for each project

**Why it exists:** When a user provides `.proto` files, kaja compiles them at runtime to TypeScript using `protoc-gen-ts`. These sources are then bundled into a stub that gets loaded into the Monaco editor for autocomplete and type checking.

#### `/desktop/frontend/dist` (Git Ignored)
**Purpose:** Desktop frontend assets copied from server build
**Created by:** `scripts/desktop`
**Contents:**
- `main.js`, `main.css`, `codicon-37A3DWZT.ttf`
- `static/` directory with `index.html`, `favicon.*` files

**Why it exists:** The desktop app needs the same UI bundle as the server. Files are copied from `server/build/` to keep a single source of truth. Wails embeds these via `//go:embed all:frontend/dist` in `desktop/main.go`.

#### `/ui/node_modules` (Git Ignored)
**Purpose:** NPM dependencies
**Created by:** `npm install`

### Development vs Production Builds

#### Server Development (`scripts/server`)
**Build Process:**
1. Install protoc plugins to `/build`
2. Build demo workspace apps
3. Run `go run server/cmd/build-ui/main.go` - creates esbuild bundles in `server/build/`
4. Generate server protobufs
5. Run server with `-tags development` flag

**Development Mode Features:**
- Uses `server/assets_development.go` (build tag: `development`)
- Reads files from disk on each request (no embed)
- Enables hot reloading of UI changes
- Binary built to `/tmp/kaja`

#### Server Production (Dockerfile)
**Build Process:**
1. `npm ci` in `ui/` directory
2. Run tests (if `RUN_TESTS=true`)
3. `go run server/cmd/build-ui/main.go` - creates bundles
4. `go build ./cmd/server` (without development tag)

**Production Mode Features:**
- Uses `server/assets_production.go` (default, no build tag)
- Files embedded at compile time via `//go:embed`
- Single binary with all assets included
- Optimized for Docker deployment

#### Desktop Development (`scripts/desktop`)
**Build Process:**
1. Build demo workspace apps
2. Run `go run server/cmd/build-ui/main.go`
3. Copy `server/build/*` to `desktop/frontend/dist/`
4. Copy `server/static/*` to `desktop/frontend/dist/`
5. Run `wails dev`

**Desktop Mode Features:**
- Wails provides native window and OS integration
- Same UI bundle as server
- Hot reload during development
- Embeds frontend via `//go:embed all:frontend/dist`

#### Desktop Production
**Build Process:**
- `wails build` creates platform-specific binaries in `desktop/build/bin/`
- Assets embedded in binary

### Key Build Scripts

- **`scripts/server`** - Development server (Go + React)
- **`scripts/desktop`** - Desktop app development (Wails)
- **`scripts/docker`** - Docker container build and run
- **`scripts/common`** - Shared functions for demo apps

### Generated Files (Do Not Edit)

- `ui/src/wailsjs/**` - Generated by Wails CLI
- `ui/src/server/**` - Generated by protoc from `server/proto/api.proto`
- `server/proto/**/*.pb.go` - Generated by protoc-gen-go
- `server/proto/**/*.twirp.go` - Generated by protoc-gen-twirp
- `/build/sources/{project}/**` - Generated at runtime from user's `.proto` files

### Why Multiple Build Directories?

1. **`/build`** - Shared tooling needed by both server and desktop at runtime
2. **`/server/build`** - Server-specific UI artifacts for embedding
3. **`/desktop/build/`** - Desktop-specific artifacts (binaries, runtime sources)
4. **`/desktop/frontend/dist`** - Desktop frontend copied from server (keeps single source)

This structure allows:
- **Server** to embed UI and serve it without external dependencies
- **Desktop** to reuse the same UI in a native window
- **Runtime** protobuf compilation for user's projects
- **Development** mode with hot reloading
- **Production** mode with optimized, embedded assets
