## Guidelines

- See [Development](README.md#development) for instructions how to run and test.
- Only add code comments for really tricky parts; otherwise keep it clean.
- If API is called "getConfiguration", use "configuration" not "config" in code.
- Don't run `go build` directly; use `scripts/server` and/or `scripts/desktop`. Kill `scripts/server` when done. Make sure the server port is not in use.
- The is using https://primer.style/product/getting-started/react/. Use out-of-the-box Primer components as much as possible. Avoid custom styling unless absolutely necessary.
- Don't update generated files directly; they will be overwritten.
  - `ui/src/wailsjs/**` are generated by Wails.
- When I prompt you to make changes that are radically different from what's documented here, please update this file accordingly.
- Don't commit changes to `kaja.json`
- Use past tense in pull request titles and commit messages (e.g., "Fix bug" → "Fixed bug").
- Use capitalized "Kaja" for user-facing labels (titles, headings, UI text). Keep lowercase "kaja" for code, terminal commands, and file paths.

## Directory Structure

```
/
├── desktop/          # Desktop application (Wails framework)
├── server/           # Backend server (Go) - serves both web and desktop
├── ui/               # Frontend UI (React/TypeScript)
├── workspace/        # Demo workspace with example proto definitions
├── scripts/          # Build and development scripts
└── docs/             # Documentation
```

### Build Directories

There are multiple `build/` directories, each serving a different purpose:

| Directory                 | Purpose                                                                                  | Gitignored |
| ------------------------- | ---------------------------------------------------------------------------------------- | ---------- |
| `/server/build/`          | Protoc plugins (protoc-gen-\*) and bundled UI assets (main.js, main.css, monaco workers) | Yes        |
| `/desktop/build/`         | Platform files (app icons, Info.plist) - tracked in git                                  | No         |
| `/desktop/build/bin/`     | Desktop executable binaries                                                              | Yes        |
| `/desktop/frontend/dist/` | Frontend distribution for desktop (copied from server/build)                             | Yes        |
| `$TMPDIR/kaja/`           | Compilation temp folders (auto-cleaned after 60 min)                                     | N/A        |

### Development vs Production Builds

The server uses Go build tags to switch between development and production modes:

**Development** (`-tags development`):

- `server/assets_development.go` is used
- Reads UI files from filesystem at runtime
- Calls `ui.BuildForDevelopment()` to rebuild assets on startup
- Allows hot-reload during development

**Production** (default, no tags):

- `server/assets_production.go` is used
- All assets are embedded in the binary via `//go:embed`
- No filesystem access needed for serving UI
- Single self-contained binary

### Server vs Desktop

Both share the same backend code but differ in how they're packaged:

**Server (Web)**:

- Single Go binary with embedded React UI
- Serves HTTP API on port 41520
- Run with: `scripts/server`
- Assets from `/server/build/` and `/server/static/`

**Desktop (Wails)**:

- Uses Wails framework (Go + webview)
- Embeds frontend via `//go:embed all:frontend/dist`
- Frontend files copied from server build to `/desktop/frontend/dist/`
- Native window and file dialogs
- Run with: `scripts/desktop`

### Source Directories

**`/ui/`** - React/TypeScript frontend:

- `src/*.tsx` - React components
- `src/server/` - Generated proto client code (from `/server/proto/api.proto`)
- `src/wailsjs/` - Generated Wails bindings (auto-generated)

**`/server/`** - Go backend:

- `cmd/server/` - Main server application
- `cmd/build-ui/` - Tool to bundle React UI with esbuild
- `pkg/api/` - Generated proto code (Go)
- `proto/api.proto` - API service definition (source of truth)
- `static/` - Static files (index.html, favicon)

**`/desktop/`** - Wails desktop app:

- `main.go` - Wails app entry point
- `frontend/dist/` - Copied from server build (gitignored)

**`/workspace/`** - Example workspace for development and testing:

- This is a demo workspace that developers use to test kaja
- `kaja.json` - Configuration file defining demo projects hosted on kaja.tools:
  - quirks, users, teams services (both gRPC and Twirp protocols)
- `quirks/`, `users/`, `teams/` - Proto files for each service
- Run `scripts/demo-protos` to update proto files from kaja-tools/website
- The `scripts/server` script starts kaja with this workspace by default

### Code Generation Flow

```
/server/proto/api.proto
         │
         ├──→ [protoc + protoc-gen-go/twirp] → /server/pkg/api/*.go
         │
         └──→ [protoc + protoc-gen-ts]       → /ui/src/server/*.ts
                                                      │
                                                      v
                                    go run cmd/build-ui/main.go (esbuild)
                                                      │
                                                      v
                                            /server/build/
                                          (main.js, main.css, workers)
                                                      │
                         ┌────────────────────────────┼────────────────────────────┐
                         │                            │                            │
                         v                            v                            v
              Server (embedded)           Desktop (copied to             Docker (embedded)
                                         /desktop/frontend/dist)
```
