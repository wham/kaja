## Guidelines

- See [Development](README.md#development) for instructions how to run and test.
- Only add code comments for really tricky parts; otherwise keep it clean.
- If API is called "getConfiguration", use "configuration" not "config" in code.
- Don't run `go build` directly; use `scripts/server`, `scripts/desktop`, or `scripts/docker`. Kill `scripts/server` when done. Make sure the server port is not in use.
- Don't run `scripts/build-ui` separately; when `scripts/server` is running, the UI is recompiled automatically on page load.
- The is using https://primer.style/product/getting-started/react/. Use out-of-the-box Primer components as much as possible. Avoid custom styling unless absolutely necessary.
- Don't update generated files directly; they will be overwritten.
  - `ui/src/server/` is generated by protoc-gen-kaja.
  - `ui/src/wailsjs/**` are generated by Wails.
- When I prompt you to make changes that are radically different from what's documented here, please update this file accordingly.
- Don't commit changes to `kaja.json`
- Use past tense in pull request titles and commit messages (e.g., "Fix bug" → "Fixed bug").
- Use capitalized "Kaja" for user-facing labels (titles, headings, UI text). Keep lowercase "kaja" for code, terminal commands, and file paths.
- Use pure Primer when possible, avoid custom wrappers and abstractions.
- Ask me before creating custom UI components; prefer direct use of Primer components.
- Keep pull-request descriptions super short - one or two sentences summarizing the change.

## Directory Structure

```
/
├── desktop/          # Desktop application (Wails framework)
├── protoc-gen-kaja/  # Protoc plugin for TypeScript codegen (Go)
├── server/           # Backend server (Go) - serves both web and desktop
├── ui/               # Frontend UI (React/TypeScript)
├── workspace/        # Demo workspace with example proto definitions
├── scripts/          # Build and development scripts
└── docs/             # Documentation
```

### Build Directories

There are multiple `build/` directories, each serving a different purpose:

| Directory                 | Purpose                                                                                  | Gitignored |
| ------------------------- | ---------------------------------------------------------------------------------------- | ---------- |
| `/server/build/`          | Protoc plugins (protoc-gen-\*) and bundled UI assets (main.js, main.css, monaco workers) | Yes        |
| `/desktop/build/`         | Platform files (app icons, Info.plist) - tracked in git                                  | No         |
| `/desktop/build/bin/`     | Desktop executable binaries                                                              | Yes        |
| `/desktop/frontend/dist/` | Frontend distribution for desktop (copied from server/build)                             | Yes        |
| `$TMPDIR/kaja/`           | Compilation temp folders (auto-cleaned after 60 min)                                     | N/A        |

### Development vs Production Builds

The server uses Go build tags to switch between development and production modes:

**Development** (`-tags development`):

- `server/assets_development.go` is used
- Reads UI files from filesystem at runtime
- Calls `ui.BuildForDevelopment()` to rebuild assets on startup
- Allows hot-reload during development

**Production** (default, no tags):

- `server/assets_production.go` is used
- All assets are embedded in the binary via `//go:embed`
- No filesystem access needed for serving UI
- Single self-contained binary

### Server vs Desktop

Both share the same backend code but differ in how they're packaged:

**Server (Web)**:

- Single Go binary with embedded React UI
- Serves HTTP API on port 41520
- Run with: `scripts/server`
- Assets from `/server/build/` and `/server/static/`

**Desktop (Wails)**:

- Uses Wails framework (Go + webview)
- Embeds frontend via `//go:embed all:frontend/dist`
- Frontend files copied from server build to `/desktop/frontend/dist/`
- Native window and file dialogs
- Run with: `scripts/desktop`

### Source Directories

**`/ui/`** - React/TypeScript frontend:

- `src/*.tsx` - React components
- `src/server/` - Generated proto client code (from `/server/proto/api.proto`)
- `src/wailsjs/` - Generated Wails bindings (auto-generated)

**`/server/`** - Go backend:

- `cmd/server/` - Main server application
- `cmd/build-ui/` - Tool to bundle React UI with esbuild
- `pkg/api/` - Generated proto code (Go)
- `proto/api.proto` - API service definition (source of truth)
- `static/` - Static files (index.html, favicon)

**`/protoc-gen-kaja/`** - Protoc plugin for TypeScript code generation:

- A Go-based protoc plugin that generates TypeScript client code from `.proto` files
- Drop-in replacement for the Node.js-based `@protobuf-ts/plugin` (`protoc-gen-ts`), producing identical output
- Eliminates the Node.js dependency for proto compilation — ships as a single native Go binary
- Has its own `go.mod` (separate Go module from `/server/`)
- Built by `scripts/server` into `server/build/protoc-gen-kaja`; shipped alongside `protoc` in production and desktop builds
- Used at build time (for `ui/src/server/` API client) and at runtime (for workspace proto compilation)
- Tests in `protoc-gen-kaja/tests/` compare output against `protoc-gen-ts` to ensure identical codegen; run with `protoc-gen-kaja/scripts/test`
- `protoc-gen-kaja/tests/000_big` is a comprehensive multi-file integration test (8 proto files across 6 directories) using an e-commerce theme. It covers: all 15 scalar types, all WKTs, all map key types (bool, int64, string, int32), map with message values, all 4 streaming RPC types, custom options (method/message/field extensions), `import public`, proto3 optional, `allow_alias` enums, reserved fields/names, deprecated messages/fields/enums/methods, `jstype` (JS_STRING, JS_NUMBER), `json_name`, TypeScript keyword field names, `__proto__` field, `oneof_kind` field, `constructor` oneof member, 4-level deep nesting, self-referential messages, nested collision (Product_Variant vs Product.Variant), runtime import collision (WireType, MessageType), cross-package name collision (Status, Metadata), empty service, idempotency levels, detached comments, and comments with special chars (`*/`, `<html>`, `\n`). When adding new codegen features, expand this test to cover them.
- Automated loop: `protoc-gen-kaja/scripts/loop` runs two agents in alternation — RALPH (fixer, reads `protoc-gen-kaja/RALPH.md`) and NELSON (adversarial tester, reads `protoc-gen-kaja/NELSON.md`). RALPH writes "DONE" to `protoc-gen-kaja/status.txt` when all tests pass; NELSON writes "HAHA" when it finds a new failing test. The loop continues until NELSON can't break it.

**`/desktop/`** - Wails desktop app:

- `main.go` - Wails app entry point
- `frontend/dist/` - Copied from server build (gitignored)

**`/workspace/`** - Example workspace for development and testing:

- This is a demo workspace that developers use to test kaja
- `kaja.json` - Configuration file defining demo projects hosted on kaja.tools:
  - quirks, users, teams services (both gRPC and Twirp protocols)
- `quirks/proto/`, `users/proto/`, `teams/proto/` - Proto files for each service
- Run `scripts/demo-protos` to update proto files from kaja-tools/website
- The `scripts/server` script starts kaja with this workspace by default

### Code Generation Flow

```
/server/proto/api.proto
         │
         ├──→ [protoc + protoc-gen-go/twirp] → /server/pkg/api/*.go
         │
         └──→ [protoc + protoc-gen-kaja]     → /ui/src/server/*.ts
                                                      │
                                                      v
                                    go run cmd/build-ui/main.go (esbuild)
                                                      │
                                                      v
                                            /server/build/
                                          (main.js, main.css, workers)
                                                      │
                         ┌────────────────────────────┼────────────────────────────┐
                         │                            │                            │
                         v                            v                            v
              Server (embedded)           Desktop (copied to             Docker (embedded)
                                         /desktop/frontend/dist)
```

## Primer Components

Available components from `@primer/react` (v38). Prefer these over custom components.

### Main (`@primer/react`)

- **ActionBar** - A collection of horizontally aligned IconButtons with overflow menu
- **ActionList** - Vertical list of interactive actions or options
- **ActionMenu** - Combines ActionList and Overlay for quick actions and selections
- **AnchoredOverlay** - Opens an Overlay positioned relative to an anchor element
- **Autocomplete** - Filter through a list and pick one or more values
- **Avatar** - Image representing a user or organization
- **AvatarStack** - Displays two or more Avatars in an inline stack
- **Banner** - Highlights important information
- **Blankslate** - Placeholder explaining why content is missing
- **BranchName** - Label component for displaying branch names
- **Breadcrumb** - Legacy breadcrumb component
- **Breadcrumbs** - Displays current page hierarchy for navigation
- **Button** - Initiates actions on a page or form
- **ButtonGroup** - Renders a series of buttons together
- **Checkbox** - Form control for single and multiple selections
- **CheckboxGroup** - Renders a set of checkboxes
- **CircleBadge** - Connects logos of third-party services visually
- **ConfirmationDialog** - Dialog for confirming destructive actions
- **CounterLabel** - Adds a count to navigational elements and buttons
- **Details** - Styled wrapper for native `<details>` element
- **Dialog** - Floating surface for transient content
- **Flash** - Inline message banner for feedback
- **FormControl** - Labelled input with optional validation and hint text
- **Header** - Page-level header bar
- **Heading** - Defines hierarchical content structure
- **IconButton** - Button displaying an icon instead of text
- **Label** - Adds contextual metadata to a design
- **LabelGroup** - Layout constraints for groups of Labels
- **Link** - Styles for hyperlink text
- **LinkButton** - Button styled as a link
- **NavList** - Vertical list of navigation links
- **Overlay** - Floating surface design patterns
- **PageHeader** - Top-level page heading
- **PageLayout** - Defines header, main, pane, and footer areas
- **Pagination** - Horizontal links for navigating paginated content
- **Popover** - Brings attention to specific UI elements
- **Portal** - Renders children into a different DOM subtree
- **ProgressBar** - Shows completion progress or part-to-whole ratios
- **Radio** - Form control for single selection from options
- **RadioGroup** - Renders mutually exclusive options
- **RelativeTime** - Displays time clearly and accessibly
- **SegmentedControl** - Pick one choice from a linear set of options
- **Select** - Dropdown for single predefined choice
- **SelectPanel** - Anchored dialog for selecting one or multiple items
- **SideNav** - Vertical navigation sidebar
- **Spinner** - Indeterminate loading indicator
- **SplitPageLayout** - Two-column layout with main content and sidebar
- **Stack** - Responsive horizontal and vertical layout flows
- **StateLabel** - Renders issue or pull request status
- **SubNav** - Secondary horizontal navigation
- **Text** - Applies Primer typographic styles
- **TextInput** - Single-line text input
- **TextInputWithTokens** - Input for list-based values
- **Textarea** - Multi-line text input
- **Timeline** - Displays items on a vertical timeline
- **ToggleSwitch** - Immediately toggles a setting on or off
- **Token** - Compact representation of an object or metadata
- **Tooltip** - Additional context on hover or keyboard focus
- **TreeView** - Hierarchical list with expandable parents
- **Truncate** - Shortens overflowing text with ellipsis
- **UnderlineNav** - Horizontal tabbed navigation
- **VisuallyHidden** - Hides content visually while keeping it accessible

### Experimental (`@primer/react/experimental`)

- **Announce** - Live region announcements for screen readers
- **AriaAlert** - Assertive live region alert
- **AriaStatus** - Polite live region status update
- **ButtonBase** - Base component for building custom buttons
- **DataTable** - 2D data structure with rows and columns
- **FeatureFlags** - Provider for toggling feature flags
- **FilteredActionList** - ActionList with built-in text filtering
- **Hidden** - Conditionally hides content at breakpoints
- **InlineMessage** - Informs users about action results within content
- **IssueLabel** - Renders GitHub issue labels
- **KeybindingHint** - Displays keyboard shortcut hints
- **ScrollableRegion** - Accessible scrollable container
- **SelectPanel2** - Next-generation SelectPanel
- **SkeletonAvatar** - Loading placeholder for Avatar
- **SkeletonBox** - Loading placeholder for non-text elements
- **SkeletonText** - Loading placeholder for text
- **Table** - Low-level table component (used by DataTable)
- **Tabs** - Tabbed interface for switching views
- **TopicTag** - Renders topic/tag labels
- **UnderlinePanels** - Tabbed panels for related content

### Deprecated (`@primer/react/deprecated`)

- **ActionList** - Legacy ActionList (use main ActionList instead)
- **ActionMenu** - Legacy ActionMenu (use main ActionMenu instead)
- **Dialog** - Legacy Dialog v1 (use main Dialog instead)
- **FilteredSearch** - Legacy filtered search input
- **Octicon** - Renders Octicon icons directly
- **Pagehead** - Legacy page heading
- **TabNav** - Legacy tab navigation (use UnderlineNav instead)
- **Tooltip** - Legacy Tooltip (use main Tooltip instead)
- **UnderlineNav** - Legacy UnderlineNav
