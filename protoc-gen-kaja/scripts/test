#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
ROOT_DIR="$(cd "$PROJECT_DIR/.." && pwd)"
TESTS_DIR="$PROJECT_DIR/tests"
RESULTS_DIR="$PROJECT_DIR/results"

SERVER_BUILD_DIR="$ROOT_DIR/server/build"
PROTOC_GEN_TS="$SERVER_BUILD_DIR/protoc-gen-ts"
PROTOC_GEN_KAJA="$SERVER_BUILD_DIR/protoc-gen-kaja"

# Parse flags
SUMMARY_ONLY=false
for arg in "$@"; do
  case "$arg" in
    --summary) SUMMARY_ONLY=true ;;
  esac
done

# -- setup ---------------------------------------------------------------

PROTOC="$SERVER_BUILD_DIR/protoc"
INCLUDE_DIR="$SERVER_BUILD_DIR/include"

# Ensure server build artifacts exist
if [ ! -x "$PROTOC" ] || [ ! -x "$PROTOC_GEN_TS" ]; then
  echo "Server build artifacts not found. Run scripts/server first."
  exit 1
fi

# Build protoc-gen-kaja into server/build
echo "Building protoc-gen-kaja..."
mkdir -p "$SERVER_BUILD_DIR"
(cd "$PROJECT_DIR" && go build -o "$PROTOC_GEN_KAJA" .)

# -- test loop ------------------------------------------------------------

PASS=0
FAIL=0
ERRORS=""

# Clean and create results directory
rm -rf "$RESULTS_DIR"
mkdir -p "$RESULTS_DIR"

WORKSPACE_DIR="$ROOT_DIR/workspace"

# Function to run a single test
run_test() {
  local test_name="$1"
  local test_dir="${2%/}"  # Remove trailing slash if present
  local recursive="$3"
  local expected_dir="$RESULTS_DIR/$test_name/expected"
  local actual_dir="$RESULTS_DIR/$test_name/actual"

  mkdir -p "$expected_dir" "$actual_dir"

  # Collect proto files
  if [ "$recursive" = "true" ]; then
    proto_files=$(find "$test_dir" -name "*.proto" | sort)
  else
    proto_files=$(find "$test_dir" -maxdepth 1 -name "*.proto" | sort)
  fi
  
  if [ -z "$proto_files" ]; then
    return
  fi

  # Convert to relative paths from test_dir
  proto_basenames=""
  for f in $proto_files; do
    rel_path="${f#$test_dir/}"
    proto_basenames="$proto_basenames $rel_path"
  done

  # Run protoc-gen-ts (expected output)
  ts_ok=true
  (cd "$test_dir" && "$PROTOC" \
    --plugin="protoc-gen-ts=$PROTOC_GEN_TS" \
    --ts_out="$expected_dir" \
    --ts_opt=long_type_string \
    -I"$INCLUDE_DIR" \
    -I. \
    $proto_basenames) 2>/dev/null || ts_ok=false

  if [ "$ts_ok" = false ]; then
    echo "SKIP $test_name (protoc-gen-ts failed)"
    return
  fi

  # Run protoc-gen-kaja (actual output)
  kaja_ok=true
  (cd "$test_dir" && "$PROTOC" \
    --plugin="protoc-gen-kaja=$PROTOC_GEN_KAJA" \
    --kaja_out="$actual_dir" \
    --kaja_opt=long_type_string \
    -I"$INCLUDE_DIR" \
    -I. \
    $proto_basenames) 2>/dev/null || kaja_ok=true  # empty response is OK

  # Compare outputs
  diff_output=$(diff -ruN "$expected_dir" "$actual_dir" 2>&1) || true

  if [ -z "$diff_output" ]; then
    PASS=$((PASS + 1))
    if [ "$SUMMARY_ONLY" = false ]; then
      echo "PASS $test_name"
    fi
  else
    FAIL=$((FAIL + 1))
    ERRORS="$ERRORS\n--- $test_name ---\n$diff_output"
    if [ "$SUMMARY_ONLY" = false ]; then
      echo "FAIL $test_name"
      echo "$diff_output" | head -40
      echo ""
    fi
  fi
}

# Run numbered tests
for test_dir in "$TESTS_DIR"/*/; do
  if [ -d "$test_dir" ]; then
    test_name="$(basename "$test_dir")"
    run_test "$test_name" "$test_dir" "false"
  fi
done

# Run workspace project tests
for project in grpcbin quirks teams users; do
  proto_dir="$WORKSPACE_DIR/$project/proto"
  if [ -d "$proto_dir" ]; then
    run_test "$project" "$proto_dir" "true"
  fi
done

# -- summary --------------------------------------------------------------

TOTAL=$((PASS + FAIL))
echo ""
echo "Results: $PASS/$TOTAL passed, $FAIL/$TOTAL failed"

if [ "$FAIL" -gt 0 ]; then
  if [ "$SUMMARY_ONLY" = true ]; then
    # In summary mode, show just the names of failing tests
    echo ""
    echo "Failing tests:"
    echo -e "$ERRORS" | grep "^--- " | sed 's/^--- /  /' | sed 's/ ---$//'
  fi
  exit 1
fi
