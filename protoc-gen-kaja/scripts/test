#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
ROOT_DIR="$(cd "$PROJECT_DIR/.." && pwd)"
TESTS_DIR="$PROJECT_DIR/tests"
RESULTS_DIR="$PROJECT_DIR/results"

SERVER_BUILD_DIR="$ROOT_DIR/server/build"
PROTOC_GEN_TS="$SERVER_BUILD_DIR/protoc-gen-ts"
PROTOC_GEN_KAJA="$SERVER_BUILD_DIR/protoc-gen-kaja"

# Parse flags
SUMMARY_ONLY=false
for arg in "$@"; do
  case "$arg" in
    --summary) SUMMARY_ONLY=true ;;
  esac
done

# -- setup ---------------------------------------------------------------

PROTOC="$SERVER_BUILD_DIR/protoc"
INCLUDE_DIR="$SERVER_BUILD_DIR/include"

# Ensure server build artifacts exist
if [ ! -x "$PROTOC" ] || [ ! -x "$PROTOC_GEN_TS" ]; then
  echo "Server build artifacts not found. Run scripts/server first."
  exit 1
fi

# Build protoc-gen-kaja into server/build
echo "Building protoc-gen-kaja..."
mkdir -p "$SERVER_BUILD_DIR"
(cd "$PROJECT_DIR" && go build -o "$PROTOC_GEN_KAJA" .)

# -- test loop ------------------------------------------------------------

PASS=0
FAIL=0
ERRORS=""

# Clean and create results directory
rm -rf "$RESULTS_DIR"
mkdir -p "$RESULTS_DIR"

WORKSPACE_DIR="$ROOT_DIR/workspace"

# Function to run a single test
run_test() {
  local test_name="$1"
  local test_dir="${2%/}"  # Remove trailing slash if present
  local recursive="$3"
  local expected_dir="$RESULTS_DIR/$test_name/expected"
  local actual_dir="$RESULTS_DIR/$test_name/actual"

  mkdir -p "$expected_dir" "$actual_dir"

  # Collect proto files
  if [ "$recursive" = "true" ]; then
    proto_files=$(find "$test_dir" -name "*.proto" | sort)
  else
    proto_files=$(find "$test_dir" -maxdepth 1 -name "*.proto" | sort)
  fi
  
  if [ -z "$proto_files" ]; then
    return
  fi

  # Convert to relative paths from test_dir
  proto_basenames=""
  for f in $proto_files; do
    rel_path="${f#$test_dir/}"
    proto_basenames="$proto_basenames $rel_path"
  done

  # Run protoc-gen-ts (expected output)
  ts_error_file="$RESULTS_DIR/$test_name/ts_error.txt"
  ts_ok=true
  (cd "$test_dir" && "$PROTOC" \
    --plugin="protoc-gen-ts=$PROTOC_GEN_TS" \
    --ts_out="$expected_dir" \
    --ts_opt=long_type_string \
    -I"$INCLUDE_DIR" \
    -I. \
    $proto_basenames) 2>"$ts_error_file" || ts_ok=false

  # Run protoc-gen-kaja (actual output)
  kaja_error_file="$RESULTS_DIR/$test_name/kaja_error.txt"
  kaja_ok=true
  (cd "$test_dir" && "$PROTOC" \
    --plugin="protoc-gen-kaja=$PROTOC_GEN_KAJA" \
    --kaja_out="$actual_dir" \
    --kaja_opt=long_type_string \
    -I"$INCLUDE_DIR" \
    -I. \
    $proto_basenames) 2>"$kaja_error_file" || kaja_ok=false

  # If both failed, compare error messages
  if [ "$ts_ok" = false ] && [ "$kaja_ok" = false ]; then
    ts_err=$(cat "$ts_error_file" 2>/dev/null || echo "")
    kaja_err=$(cat "$kaja_error_file" 2>/dev/null || echo "")
    
    # Normalize whitespace and compare
    ts_err_normalized=$(echo "$ts_err" | sed 's/[[:space:]]*$//' | sed '/^$/d')
    kaja_err_normalized=$(echo "$kaja_err" | sed 's/[[:space:]]*$//' | sed '/^$/d')
    
    if [ "$ts_err_normalized" = "$kaja_err_normalized" ]; then
      PASS=$((PASS + 1))
      if [ "$SUMMARY_ONLY" = false ]; then
        echo "PASS $test_name (both failed with same error)"
      fi
    else
      FAIL=$((FAIL + 1))
      diff_output=$(diff -u \
        <(echo "$ts_err" | sed 's/[[:space:]]*$//') \
        <(echo "$kaja_err" | sed 's/[[:space:]]*$//') \
        2>&1) || true
      diff_header="--- protoc-gen-ts error\n+++ protoc-gen-kaja error"
      ERRORS="$ERRORS\n--- $test_name (error mismatch) ---\n$diff_header\n$diff_output"
      if [ "$SUMMARY_ONLY" = false ]; then
        echo "FAIL $test_name (error mismatch)"
        echo -e "$diff_header"
        echo "$diff_output" | head -40
        echo ""
      fi
    fi
    return
  fi

  # If one succeeded and the other failed, it's a failure
  if [ "$ts_ok" != "$kaja_ok" ]; then
    FAIL=$((FAIL + 1))
    if [ "$ts_ok" = true ]; then
      error_msg="protoc-gen-kaja failed but protoc-gen-ts succeeded"
      kaja_err=$(cat "$kaja_error_file" 2>/dev/null || echo "(no error output)")
      ERRORS="$ERRORS\n--- $test_name ---\n$error_msg\n\nKaja error:\n$kaja_err"
    else
      error_msg="protoc-gen-ts failed but protoc-gen-kaja succeeded"
      ts_err=$(cat "$ts_error_file" 2>/dev/null || echo "(no error output)")
      ERRORS="$ERRORS\n--- $test_name ---\n$error_msg\n\nTS error:\n$ts_err"
    fi
    if [ "$SUMMARY_ONLY" = false ]; then
      echo "FAIL $test_name"
      if [ "$ts_ok" = true ]; then
        echo "  protoc-gen-kaja failed but protoc-gen-ts succeeded"
        echo ""
        echo "Kaja error:"
        echo "$kaja_err" | head -20
      else
        echo "  protoc-gen-ts failed but protoc-gen-kaja succeeded"
        echo ""
        echo "TS error:"
        echo "$ts_err" | head -20
      fi
      echo ""
    fi
    return
  fi

  # Compare outputs
  diff_output=$(diff -ruN "$expected_dir" "$actual_dir" 2>&1) || true

  if [ -z "$diff_output" ]; then
    PASS=$((PASS + 1))
    if [ "$SUMMARY_ONLY" = false ]; then
      echo "PASS $test_name"
    fi
  else
    FAIL=$((FAIL + 1))
    ERRORS="$ERRORS\n--- $test_name ---\n$diff_output"
    if [ "$SUMMARY_ONLY" = false ]; then
      echo "FAIL $test_name"
      echo "$diff_output" | head -40
      echo ""
    fi
  fi
}

# Run numbered tests
for test_dir in "$TESTS_DIR"/*/; do
  if [ -d "$test_dir" ]; then
    test_name="$(basename "$test_dir")"
    # Test 28_comprehensive needs recursive scanning due to subdirectories
    if [ "$test_name" = "28_comprehensive" ]; then
      run_test "$test_name" "$test_dir" "true"
    else
      run_test "$test_name" "$test_dir" "false"
    fi
  fi
done

# Run workspace project tests
for project in grpcbin quirks teams users; do
  proto_dir="$WORKSPACE_DIR/$project/proto"
  if [ -d "$proto_dir" ]; then
    run_test "$project" "$proto_dir" "true"
  fi
done

# -- summary --------------------------------------------------------------

TOTAL=$((PASS + FAIL))
echo ""
echo "Results: $PASS/$TOTAL passed, $FAIL/$TOTAL failed"

if [ "$FAIL" -gt 0 ]; then
  if [ "$SUMMARY_ONLY" = true ]; then
    # In summary mode, show just the names of failing tests
    echo ""
    echo "Failing tests:"
    echo -e "$ERRORS" | grep "^--- " | sed 's/^--- /  /' | sed 's/ ---$//'
  fi
  exit 1
fi
